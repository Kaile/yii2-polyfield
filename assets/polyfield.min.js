
var Polyfield,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};Polyfield=(function(){a.prototype.types={STRING:"string",DROPDOWN:"dropdown",DATE:"date"};function a(){jQuery("body").on("blur",'input[type="text"]',function(){return jQuery(this).val(jQuery(this).val().trim())});this.i18n={}}a.prototype.models={};a.prototype.completes=[];a.prototype.push=function(b){if(typeof b!=="object"){return console.log("Bad identifier for polyfield "+b)}b.counter=0;b.existsShowen=b.exists?false:true;this.models[b.id]=b;this.appendExists(b.id);return this.bindEvent(b.id)};a.prototype.bindEvent=function(d){var b,c=this;if(typeof this.models[d]==="undefined"){return console.log("Can not find object for what need to bind event")}b=jQuery("#button_"+d);return b.on("click",function(){c.hideExcess(d);return c.appendTemplate(d)})};a.prototype.hideExcess=function(b){if(jQuery("."+b).length){return jQuery("."+b).collapsible("closeAll")}};a.prototype.generateLabel=function(b,d){var c;c=document.createElement("label");c.setAttribute("class","col-lg-3 control-label");c.setAttribute("for",b);c.appendChild(document.createTextNode(d));return c};a.prototype.generateInput=function(e,g,f,c,l,h,j){var d,b,i,k;if(typeof l==="undefined"){l=""}if(typeof h==="undefined"){h="hidden"}if(typeof j==="undefined"){j=false}b=document.createElement("div");b.setAttribute("class","form-group");if(j){b.appendChild(this.generateLabel(f+c,j))}d=document.createElement("div");d.setAttribute("class","col-lg-5");i=document.createElement("input");i.setAttribute("type",h);i.setAttribute("name",""+g+"["+c+"]["+f+"]");if(h!=="hidden"){k=f+e+c;i.setAttribute("id",k);this.addToAutocomplete(k,g,f)}i.setAttribute("class","form-control");i.setAttribute("value",l);d.appendChild(i);b.appendChild(d);return b};a.prototype.generateOptions=function(i,c,e){var b,f,j,h,d,g;if(typeof b==="undefined"){b=false}j=document.createDocumentFragment();i=i.sort(function(l,k){var n,m;n=l[c].toUpperCase();m=k[c].toUpperCase();if(n>m){return 1}if(n<m){return -1}return 0});for(d=0,g=i.length;d<g;d++){h=i[d];f=document.createElement("option");f.setAttribute("value",h.id);f.appendChild(document.createTextNode(h[c]));if(Number(h.id)===Number(e)){f.setAttribute("selected",true)}j.appendChild(f)}return j};a.prototype.generateDropdown=function(p,o,m,j,i,d,r,t){var e,n,l,k,b,h,g,f,q,c,s=this;if(typeof r==="undefined"){r=false}if(typeof t==="undefined"){t=false}f=document.createElement("div");e=document.createDocumentFragment();f.setAttribute("class","form-group");f.appendChild(this.generateLabel(m+j,i));n=document.createElement("div");n.setAttribute("class","col-lg-5");q=document.createElement("select");q.setAttribute("name",""+o+"["+j+"][id]");q.appendChild(this.generateOptions(d,m,r));c=m+p+j;q.setAttribute("id",c);q.setAttribute("class","form-control");if(t){b=document.createElement("div");b.setAttribute("class","form-group");b.appendChild(this.generateLabel("filter"+j,this.translate("filter")));h=document.createElement("select");h.setAttribute("id","filter"+j);g=d.filter(function(v,u,w){return !v[t]});l=document.createElement("option");l.setAttribute("value",0);l.appendChild(document.createTextNode(this.translate("noFilter")));h.appendChild(l);h.appendChild(this.generateOptions(g,m));h.setAttribute("class","form-control");k=n.cloneNode();k.appendChild(h);b.appendChild(k);e.appendChild(b);jQuery(h).on("change",function(){var w,v,u;w=jQuery(h);v=jQuery(q);v.empty();u=d.filter(function(y,x,z){if(w.val()==="0"){return true}if(Number(w.val())===Number(y[t])){return true}else{return false}});return q.appendChild(s.generateOptions(u,m,r))})}n.appendChild(q);f.appendChild(n);e.appendChild(f);return e};a.prototype.generateDateInput=function(d,h,e,c,m,i,l){var j,b,k,g,f;if(typeof m==="undefined"){m=""}if(typeof i==="undefined"){i="hidden"}if(typeof l==="undefined"){l=false}b=document.createElement("div");b.setAttribute("class","form-group");if(l){b.appendChild(this.generateLabel(e+c,l))}j=document.createElement("div");j.setAttribute("class","col-lg-5 input-group date");k=document.createElement("input");k.setAttribute("class","form-control");k.setAttribute("type",i);k.setAttribute("name",""+h+"["+c+"]["+e+"]");k.setAttribute("value",m);g=document.createElement("span");g.setAttribute("class","input-group-addon");f=document.createElement("span");f.setAttribute("class","glyphicon glyphicon-calendar");g.appendChild(f);j.appendChild(k);j.appendChild(g);b.appendChild(j);$(j).datetimepicker({locale:"ru",viewMode:"years",format:"YYYY-MM-DD"});return b};a.prototype.generateCollapsible=function(h,c,b){var g,f,d,e;d=h+b;e="section_"+d;f=document.createElement("div");f.setAttribute("id",e);f.setAttribute("class",h);f.appendChild(document.createTextNode(b+". "+c));f.appendChild(document.createElement("span"));g=document.createElement("div");g.appendChild(document.createTextNode("x"));g.setAttribute("id","exit_"+d);g.setAttribute("class","polyfield-exit");g.setAttribute("title",this.translate("deleteElement"));f.appendChild(g);this.bindClose(d);return f};a.prototype.generateContainer=function(c){var b,d;d=document.createElement("div");d.setAttribute("class","content");d.appendChild(document.createElement("div"));d.appendChild(c);b=document.createElement("div");b.setAttribute("class","container");b.appendChild(d);return b};a.prototype.appendTemplate=function(b){var c,i,j,g,f,e,h,d;e=this.models[b];e.counter++;h="section_"+b+e.counter;j=this.generateCollapsible(b,e.label,e.counter);g=document.createElement("p");if(e.type===this.types.STRING||e.type===this.types.DATE){d=e.attributes;for(f in d){c=d[f];if(__indexOf.call(e.dateAttributes,c)>=0){g.appendChild(this.generateDateInput(b,e.name,c,e.counter,"","text",e.attributeLabels[c]));continue}g.appendChild(this.generateInput(b,e.name,c,e.counter,"","text",e.attributeLabels[c]))}}else{if(e.type===this.types.DROPDOWN){g.appendChild(this.generateDropdown(b,e.name,e.dropdownAttribute,e.counter,e.attributeLabels[e.dropdownAttribute],e.dropdownValues,"",e.filterAttribute))}}i=document.createDocumentFragment();i.appendChild(j);i.appendChild(this.generateContainer(g));document.getElementById("content_"+b).appendChild(i);jQuery("#"+h).collapsible({defaultOpen:""+h});return this.bindAutocomplete()};a.prototype.appendExists=function(b){var c,n,h,k,j,i,e,m,f,l,g,d;i=this.models[b];if(i.existsShowen){return}g=i.exists;for(f=0,l=g.length;f<l;f++){e=g[f];i.counter++;m="section_"+b+i.counter;n=this.generateCollapsible(b,i.label,i.counter);k=document.createElement("p");if(i.type===this.types.STRING||i.type===this.types.DATE){d=i.attributes;for(j in d){c=d[j];if(__indexOf.call(i.dateAttributes,c)>=0){k.appendChild(this.generateDateInput(b,i.name,c,i.counter,e[c],"text",i.attributeLabels[c]));continue}k.appendChild(this.generateInput(b,i.name,c,i.counter,e[c],"text",i.attributeLabels[c]))}}else{if(i.type===this.types.DROPDOWN){k.appendChild(this.generateDropdown(b,i.name,i.dropdownAttribute,i.counter,i.attributeLabels[i.dropdownAttribute],i.dropdownValues,e.id,i.filterAttribute))}}h=document.createDocumentFragment();h.appendChild(n);h.appendChild(this.generateContainer(k));document.getElementById("content_"+b).appendChild(h);jQuery("#"+m).collapsible({defaultOpen:""+m});this.bindAutocomplete()}return i.existsShowen=true};a.prototype.bindClose=function(c){var b=this;return jQuery("body").on("click","#exit_"+c,function(){if(confirm(b.translate("deleteConfirmation"))){jQuery("#section_"+c).next().remove();return jQuery("#section_"+c).remove()}})};a.prototype.addToAutocomplete=function(c,b,d){return this.completes.push({id:c,modelName:b,attribute:d})};a.prototype.bindAutocomplete=function(){var e,b,d,g,c,f;f=this.completes;for(g=0,c=f.length;g<c;g++){e=f[g];b=jQuery("#"+e.id);if(typeof b==="undefined"){console.error("Bad selector identifier gets for input autocomplete")}d=location.protocol+"//"+location.host+"/content/autocomplete";b.autocomplete({serviceUrl:d,noSuggestionNotice:this.translate("noResults"),deferRequestBy:200,params:{modelName:e.modelName,attributeName:e.attribute}})}return this.completes=[]};a.prototype.setTranslation=function(b){return this.i18n=b};a.prototype.translate=function(b){if(typeof this.i18n[b]!=="undefined"){return this.i18n[b]}else{return b}};return a})();window.polyfield=new Polyfield();