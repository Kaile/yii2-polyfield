"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(function(){var Polyfield,indexOf=[].indexOf;Polyfield=function(){var Polyfield=function(){function Polyfield(){_classCallCheck(this,Polyfield),jQuery("body").on("blur",'input[type="text"]',function(){return jQuery(this).val(jQuery(this).val().trim())}),this.i18n={}}return _createClass(Polyfield,[{key:"push",value:function push(model){return"object"!==(void 0===model?"undefined":_typeof(model))?console.log("Bad identifier for polyfield "+model):(model.counter=0,model.existsShowen=!model.exists,this.models[model.id]=model,this.appendExists(model.id),this.bindEvent(model.id))}},{key:"bindEvent",value:function bindEvent(id){var _this=this,button;return void 0===this.models[id]?console.log("Can not find object for what need to bind event"):(button=jQuery("#button_"+id)).on("click",function(){return _this.hideExcess(id),_this.appendTemplate(id)})}},{key:"hideExcess",value:function hideExcess(id){if(jQuery("."+id).length)return jQuery("."+id).collapsible("closeAll")}},{key:"generateLabel",value:function generateLabel(forId,name,htmlClass){var label;return htmlClass=htmlClass||"col-xs-4 col-sm-4 col-md-3 col-lg-3",(label=document.createElement("label")).setAttribute("class",htmlClass+" control-label"),label.setAttribute("for",forId),label.appendChild(document.createTextNode(name)),label}},{key:"generateInput",value:function generateInput(id,modelName,attribute,counter,value,type,label,autocomplete){var div,formGroup,input,inputId;return void 0!==value&&value||(value=""),void 0===type&&(type="hidden"),void 0===label&&(label=!1),void 0===autocomplete&&(autocomplete=!0),(formGroup=document.createElement("div")).setAttribute("class","form-group"),type!==this.inputTypes.HIDDEN&&label&&formGroup.appendChild(this.generateLabel(attribute+counter,label)),(div=document.createElement("div")).setAttribute("class","col-xs-6 col-sm-6 col-md-7 col-lg-7"),(input=document.createElement("input")).setAttribute("type",type),input.setAttribute("name",modelName+"["+counter+"]["+attribute+"]"),type!==this.inputTypes.HIDDEN&&(inputId=attribute+id+counter,input.setAttribute("id",inputId),!0===autocomplete&&this.addToAutocomplete(inputId,modelName,attribute)),"checkbox"===type&&value&&input.setAttribute("checked","checked"),input.setAttribute("class","form-control"),"checkbox"!==type?input.setAttribute("value",value):input.setAttribute("value","1"),div.appendChild(input),formGroup.appendChild(div),formGroup}},{key:"generateEditor",value:function generateEditor(id,modelName,attribute,counter,value,type,label){var div,formGroup,input,inputId,script;return void 0===value&&(value=""),void 0===type&&(type="hidden"),void 0===label&&(label=!1),(formGroup=document.createElement("div")).setAttribute("class","form-group"),label&&formGroup.appendChild(this.generateLabel(attribute+counter,label,"col-xs-1")),(div=document.createElement("div")).setAttribute("class","col-xs-9"),(input=document.createElement("textarea")).setAttribute("name",modelName+"["+counter+"]["+attribute+"]"),inputId=attribute+id+counter,input.setAttribute("id",inputId),input.setAttribute("class","form-control"),input.appendChild(document.createTextNode(value)),div.appendChild(input),(script=document.createElement("script")).appendChild(document.createTextNode("tinymce.init({ selector: '#"+inputId+"', language: 'ru', relative_urls: false, remove_script_host: false, height: 300, fontsize_formats: '6pt 7pt 8pt 9pt 10pt 11pt 12pt 13pt 14pt 15pt 16pt 18pt 20pt 24pt 28pt 36pt 40pt 48pt', plugins: [ 'advlist autolink lists link image charmap print preview hr anchor pagebreak', 'searchreplace wordcount visualblocks visualchars code fullscreen', 'insertdatetime media nonbreaking save table contextmenu directionality', 'emoticons template paste textcolor quotes insertfbframe' ], toolbar: [ 'undo redo | fontsizeselect | bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | forecolor backcolor | print preview media frame' ], image_advtab: true, image_class_list: [ {title: 'Без масштабирования', value: 'no-scale-image'}, {title: 'С масштабированием', value: 'scale-image'} ], image_caption: true });")),div.appendChild(script),formGroup.appendChild(div),formGroup}},{key:"generateOptions",value:function generateOptions(values,attribute,selected,sortAttr,attributePrefix,valueAttribute,exists){var existingValues,filter,j,key,len,option,optionValue,options,value;if(void 0===attributePrefix&&(attributePrefix=""),void 0===filter&&(filter=!1),sortAttr=sortAttr||attribute,valueAttribute||(valueAttribute="id"),exists||(exists=[]),options=document.createDocumentFragment(),values.sort)for(values=values.sort(function(a,b){var first,second;return a[sortAttr]?b[sortAttr]?(first=a[sortAttr].toUpperCase())>(second=b[sortAttr].toUpperCase())?1:first<second?-1:0:1:-1}),existingValues=exists.map(function(value){return value[attribute]}),j=0,len=(values=values.filter(function(value){return-1===existingValues.indexOf(value[attribute])})).length;j<len;j++)optionValue=(value=values[j])[attribute],attributePrefix.length&&(optionValue=value[attributePrefix]+" - "+optionValue),(option=document.createElement("option")).setAttribute("value",value[valueAttribute]),option.appendChild(document.createTextNode(optionValue)),String(value[valueAttribute])===String(selected)&&option.setAttribute("selected",!0),options.appendChild(option);else for(key in values)optionValue=value=values[key],(option=document.createElement("option")).setAttribute("value",key),option.appendChild(document.createTextNode(optionValue)),String(key)===String(selected)&&option.setAttribute("selected",!0),options.appendChild(option);return options}},{key:"generateDropdown",value:function generateDropdown(id,modelName,attribute,counter,label,values,selected,filterAttr,sortAttr,attributePrefix,valueAttribute,exists){var _this2=this,ddFragment,div,emptyOption,filterDiv,filterFormGroup,filterSelect,_filterValues,formGroup,select,selectId;return void 0===attributePrefix&&(attributePrefix=""),void 0===selected&&(selected=!1),void 0===filterAttr&&(filterAttr=!1),formGroup=document.createElement("div"),ddFragment=document.createDocumentFragment(),selectId=attribute+id+counter,formGroup.setAttribute("class","form-group"),formGroup.appendChild(this.generateLabel(selectId,label)),(div=document.createElement("div")).setAttribute("class","col-xs-6 col-sm-6 col-md-7 col-lg-7"),(select=document.createElement("select")).setAttribute("name",modelName+"["+counter+"]["+valueAttribute+"]"),select.appendChild(this.generateOptions(values,attribute,selected,sortAttr,attributePrefix,valueAttribute,exists)),select.setAttribute("id",selectId),select.setAttribute("class","form-control"),filterAttr&&((filterFormGroup=document.createElement("div")).setAttribute("class","form-group"),filterFormGroup.appendChild(this.generateLabel("filter"+counter,this.translate("filter"))),(filterSelect=document.createElement("select")).setAttribute("id","filter"+counter),_filterValues=values.filter(function(value,index,array){return!value[filterAttr]}),(emptyOption=document.createElement("option")).setAttribute("value",0),emptyOption.appendChild(document.createTextNode(this.translate("noFilter"))),filterSelect.appendChild(emptyOption),filterSelect.appendChild(this.generateOptions(_filterValues,attribute,null,sortAttr,attributePrefix,valueAttribute)),filterSelect.setAttribute("class","form-control"),(filterDiv=div.cloneNode()).appendChild(filterSelect),filterFormGroup.appendChild(filterDiv),ddFragment.appendChild(filterFormGroup),jQuery(filterSelect).on("change",function(){var $filter,$select,filteredValues;return _filterValues=function filterValues(filterVal,values,filterAttr){var filtered,item,j,len;if(0===(filterVal=Number(filterVal)))return values;if((filtered=values.filter(function(value){return filterVal===Number(value[filterAttr])})).length)for(j=0,len=filtered.length;j<len;j++)item=filtered[j],filtered=filtered.concat(_filterValues(item.id,values,filterAttr));return filtered},$filter=jQuery(filterSelect),($select=jQuery(select)).empty(),filteredValues=_filterValues($filter.val(),values,filterAttr),select.appendChild(_this2.generateOptions(filteredValues,attribute,selected,sortAttr,attributePrefix,valueAttribute))})),div.appendChild(select),formGroup.appendChild(div),ddFragment.appendChild(formGroup),ddFragment}},{key:"generateDateInput",value:function generateDateInput(id,modelName,attribute,counter,value,type,label){var divDate,formGroup,input,spanAddon,spanIcon;return void 0===value&&(value=""),void 0===type&&(type="hidden"),void 0===label&&(label=!1),(formGroup=document.createElement("div")).setAttribute("class","form-group"),label&&formGroup.appendChild(this.generateLabel(attribute+counter,label)),(divDate=document.createElement("div")).setAttribute("class","col-lg-5 input-group date"),(input=document.createElement("input")).setAttribute("class","form-control"),input.setAttribute("type",type),input.setAttribute("name",modelName+"["+counter+"]["+attribute+"]"),input.setAttribute("value",value),(spanAddon=document.createElement("span")).setAttribute("class","input-group-addon"),(spanIcon=document.createElement("span")).setAttribute("class","glyphicon glyphicon-calendar"),spanAddon.appendChild(spanIcon),divDate.appendChild(input),divDate.appendChild(spanAddon),formGroup.appendChild(divDate),$(divDate).datetimepicker({locale:"ru",viewMode:"years",format:"YYYY-MM-DD",keepInvalid:!0}),formGroup}},{key:"generateOrder",value:function generateOrder(modelId,modelName,counter){var classSelector,ddFragment,div,formGroup,select,selectId;return formGroup=document.createElement("div"),ddFragment=document.createDocumentFragment(),classSelector="order-"+modelName,formGroup.setAttribute("class","form-group"),formGroup.appendChild(this.generateLabel(modelName+modelId+counter,this.translate("order"))),(div=document.createElement("div")).setAttribute("class","col-lg-offset-1 col-lg-3 text-center"),(select=document.createElement("select")).setAttribute("name",modelName+"["+counter+"][order]"),select.appendChild(this.orderOptions(counter)),this.updateOrder(classSelector,counter),selectId=modelName+modelId+counter,select.setAttribute("id",selectId),select.setAttribute("class","form-control "+classSelector),div.appendChild(select),formGroup.appendChild(div),ddFragment.appendChild(formGroup),this.bindOrderListener(classSelector),ddFragment}},{key:"orderOptions",value:function orderOptions(counter){var fragment,i,j,option,ref;for(fragment=document.createDocumentFragment(),i=j=1,ref=counter;1<=ref?j<=ref:j>=ref;i=1<=ref?++j:--j)option=document.createElement("option"),i===counter&&option.setAttribute("selected","selected"),option.setAttribute("value",i),option.appendChild(document.createTextNode(i)),fragment.appendChild(option);return fragment}},{key:"updateOrder",value:function updateOrder(classSelector,counter){var $selects;($selects=$("."+classSelector)).each(function(){var $this,i,j,optLen,ref,ref1,results;if((optLen=($this=$(this)).children("option").length)<counter){for(results=[],i=j=ref=optLen+1,ref1=counter;ref<=ref1?j<=ref1:j>=ref1;i=ref<=ref1?++j:--j)results.push($this.append("<option>"+i+"</option>"));return results}})}},{key:"bindOrderListener",value:function bindOrderListener(classSelector){var _this3=this;return void 0===this.ordersListener[classSelector]&&($("body").on("focus click","."+classSelector,function(e){return _this3.ordersListener[classSelector]=e.target.value}),$("body").on("change","."+classSelector,function(e){var freeValue,self;if(self=$(e.target),(freeValue=_this3.ordersListener[classSelector])!==self.val())return $("."+classSelector).each(function(){var $this;if(($this=$(this)).val()===e.target.value&&!$this.is(self))return $this.val(freeValue)})})),!0}},{key:"generateCollapsible",value:function generateCollapsible(id,label,counter){var closer,collapsible,relativeId,sectionId;return sectionId="section_"+(relativeId=id+counter),(collapsible=document.createElement("div")).setAttribute("id",sectionId),collapsible.setAttribute("class",id),collapsible.appendChild(document.createTextNode(counter+". "+label)),collapsible.appendChild(document.createElement("span")),(closer=document.createElement("div")).appendChild(document.createTextNode("x")),closer.setAttribute("id","exit_"+relativeId),closer.setAttribute("class","polyfield-exit"),closer.setAttribute("title",this.translate("deleteElement")),collapsible.appendChild(closer),this.bindClose(relativeId),collapsible}},{key:"generateContainer",value:function generateContainer(contentBody){var container,content;return(content=document.createElement("div")).setAttribute("class","content"),content.appendChild(document.createElement("div")),content.appendChild(contentBody),(container=document.createElement("div")).setAttribute("class",""),container.appendChild(content),container}},{key:"appendTemplate",value:function appendTemplate(id){var attrType,attrValues,attribute,collapseFragment,collapsible,contentBody,index,inputElement,model,ref,ref1,sectionId;if((model=this.models[id]).counter++,sectionId="section_"+id+model.counter,collapsible=this.generateCollapsible(id,model.label,model.counter),contentBody=document.createElement("p"),model.order&&contentBody.appendChild(this.generateOrder(id,model.name,model.counter)),void 0===model.attributeTypes.length)for(attribute in ref=model.attributeTypes)attrType=ref[attribute],attrValues=null,"object"===(void 0===attrType?"undefined":_typeof(attrType))&&(attrValues=attrType.data,attrType=attrType.type),inputElement=function(){switch(!1){case attrType!==this.inputTypes.STRING:return this.generateInput(id,model.name,attribute,model.counter,"","text",model.attributeLabels[attribute],model.autocomplete);case attrType!==this.inputTypes.DATE:return this.generateDateInput(id,model.name,attribute,model.counter,"","text",model.attributeLabels[attribute]);case attrType!==this.inputTypes.TEXT:return this.generateEditor(id,model.name,attribute,model.counter,"","text",model.attributeLabels[attribute]);case attrType!==this.inputTypes.HIDDEN:return this.generateInput(id,model.name,attribute,model.counter,"","hidden",model.attributeLabels[attribute]);case attrType!==this.inputTypes.BOOLEAN:return this.generateInput(id,model.name,attribute,model.counter,"","checkbox",model.attributeLabels[attribute]);case attrType!==this.inputTypes.DROPDOWN:return this.generateDropdown(id,model.name,attribute,model.counter,model.attributeLabels[attribute],attrValues||model.dropdownValues,"",model.filterAttribute,model.sortAttribute,model.dropdownPrefixAttribute,attribute,model.dropdownUnique?model.exists:[]);default:return document.createElement("div")}}.call(this),contentBody.appendChild(inputElement);else if(model.type===this.types.STRING||model.type===this.types.DATE)for(index in ref1=model.attributes)attribute=ref1[index],indexOf.call(model.dateAttributes,attribute)>=0?contentBody.appendChild(this.generateDateInput(id,model.name,attribute,model.counter,"","text",model.attributeLabels[attribute])):contentBody.appendChild(this.generateInput(id,model.name,attribute,model.counter,"","text",model.attributeLabels[attribute],model.autocomplete));else model.type===this.types.DROPDOWN&&contentBody.appendChild(this.generateDropdown(id,model.name,model.dropdownAttribute,model.counter,model.attributeLabels[model.dropdownAttribute],model.dropdownValues,"",model.filterAttribute,model.sortAttribute,model.dropdownPrefixAttribute,model.dropdownValueAttribute,model.dropdownUnique?model.exists:[]));return(collapseFragment=document.createDocumentFragment()).appendChild(collapsible),collapseFragment.appendChild(this.generateContainer(contentBody)),document.getElementById("content_"+id).appendChild(collapseFragment),jQuery("#"+sectionId).collapsible({defaultOpen:""+sectionId}),this.createSelect2(sectionId),this.bindAutocomplete()}},{key:"appendExists",value:function appendExists(id){var attrType,attrValues,attribute,collapsible,collapsibleFragment,contentBody,dropdownValueAttribute,index,inputElement,j,len,model,object,ref,ref1,ref2,sectionId;if(!(model=this.models[id]).existsShowen){for(j=0,len=(ref=model.exists).length;j<len;j++){if(object=ref[j],model.counter++,sectionId="section_"+id+model.counter,collapsible=this.generateCollapsible(id,model.label,model.counter),contentBody=document.createElement("p"),model.order&&contentBody.appendChild(this.generateOrder(id,model.name,model.counter)),void 0===model.attributeTypes.length)for(attribute in ref1=model.attributeTypes)attrType=ref1[attribute],attrValues=null,dropdownValueAttribute=model.dropdownValueAttribute,"object"===(void 0===attrType?"undefined":_typeof(attrType))&&(attrValues=attrType.data,dropdownValueAttribute=attribute,attrType=attrType.type),inputElement=function(){switch(!1){case attrType!==this.inputTypes.STRING:return this.generateInput(id,model.name,attribute,model.counter,object[attribute],"text",model.attributeLabels[attribute],model.autocomplete);case attrType!==this.inputTypes.DATE:return this.generateDateInput(id,model.name,attribute,model.counter,object[attribute],"text",model.attributeLabels[attribute]);case attrType!==this.inputTypes.TEXT:return this.generateEditor(id,model.name,attribute,model.counter,object[attribute],"text",model.attributeLabels[attribute]);case attrType!==this.inputTypes.HIDDEN:return this.generateInput(id,model.name,attribute,model.counter,object[attribute],"hidden",model.attributeLabels[attribute]);case attrType!==this.inputTypes.BOOLEAN:return this.generateInput(id,model.name,attribute,model.counter,object[attribute],"checkbox",model.attributeLabels[attribute]);case attrType!==this.inputTypes.DROPDOWN:return this.generateDropdown(id,model.name,attribute,model.counter,model.attributeLabels[attribute],attrValues||model.dropdownValues,object[dropdownValueAttribute],model.filterAttribute,model.sortAttribute,model.dropdownPrefixAttribute,attribute);default:return document.createElement("div")}}.call(this),contentBody.appendChild(inputElement);else if(model.type===this.types.STRING||model.type===this.types.DATE||model.type===this.types.TEXT_BLOCK)for(index in ref2=model.attributes)attribute=ref2[index],indexOf.call(model.dateAttributes,attribute)>=0?contentBody.appendChild(this.generateDateInput(id,model.name,attribute,model.counter,object[attribute],"text",model.attributeLabels[attribute])):model.type===this.types.TEXT_BLOCK?contentBody.appendChild(this.generateEditor(id,model.name,attribute,model.counter,object[attribute],"text",model.attributeLabels[attribute])):contentBody.appendChild(this.generateInput(id,model.name,attribute,model.counter,object[attribute],"text",model.attributeLabels[attribute],model.autocomplete));else model.type===this.types.DROPDOWN&&contentBody.appendChild(this.generateDropdown(id,model.name,model.dropdownAttribute,model.counter,model.attributeLabels[model.dropdownAttribute],model.dropdownValues,object[model.dropdownValueAttribute],model.filterAttribute,model.sortAttribute,model.dropdownPrefixAttribute,model.dropdownValueAttribute));(collapsibleFragment=document.createDocumentFragment()).appendChild(collapsible),collapsibleFragment.appendChild(this.generateContainer(contentBody)),document.getElementById("content_"+id).appendChild(collapsibleFragment),jQuery("#"+sectionId).collapsible({defaultOpen:sectionId}),this.createSelect2(sectionId),this.bindAutocomplete()}return model.existsShowen=!0}}},{key:"bindClose",value:function bindClose(id){var _this4=this;return jQuery("body").on("click","#exit_"+id,function(){if(confirm(_this4.translate("deleteConfirmation")))return jQuery("#section_"+id).next().remove(),jQuery("#section_"+id).remove()})}},{key:"addToAutocomplete",value:function addToAutocomplete(inputId,modelName,attribute){return this.completes.push({id:inputId,modelName:modelName,attribute:attribute})}},{key:"bindAutocomplete",value:function bindAutocomplete(){var j,len,object,ref,selector,url;for(j=0,len=(ref=this.completes).length;j<len;j++)object=ref[j],void 0===(selector=jQuery("#"+object.id))&&console.error("Bad selector identifier gets for input autocomplete"),url=location.protocol+"//"+location.host+"/content/autocomplete",selector.autocomplete({serviceUrl:url,noSuggestionNotice:this.translate("noResults"),deferRequestBy:200,params:{modelName:object.modelName,attributeName:object.attribute}});return this.completes=[]}},{key:"createSelect2",value:function createSelect2(sectionId){return jQuery("#"+sectionId).next().contents().find("select").select2()}},{key:"setTranslation",value:function setTranslation(translation){return this.i18n=translation}},{key:"translate",value:function translate(textParam){return void 0!==this.i18n[textParam]?this.i18n[textParam]:textParam}}]),Polyfield}();return Polyfield.prototype.types={STRING:"string",DROPDOWN:"dropdown",DATE:"date",TEXT_BLOCK:"editor"},Polyfield.prototype.inputTypes={TEXT:"text",DATE:"date",STRING:"string",BOOLEAN:"boolean",DROPDOWN:"dropdown",SELECT2:"select2",HIDDEN:"hidden"},Polyfield.prototype.models={},Polyfield.prototype.completes=[],Polyfield.prototype.ordersListener={},Polyfield}.call(this),window.polyfield=new Polyfield}).call(void 0);