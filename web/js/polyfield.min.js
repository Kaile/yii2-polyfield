"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(function(){var e,v=[].indexOf;e=function(){var e=(_createClass(t,[{key:"push",value:function(e){return"object"!==(void 0===e?"undefined":_typeof(e))?console.log("Bad identifier for polyfield "+e):(e.counter=0,e.existsShowen=!e.exists,this.models[e.id]=e,this.appendExists(e.id),this.bindEvent(e.id))}},{key:"bindEvent",value:function(e){var t=this;return void 0===this.models[e]?console.log("Can not find object for what need to bind event"):jQuery("#button_"+e).on("click",function(){return t.hideExcess(e),t.appendTemplate(e)})}},{key:"hideExcess",value:function(e){if(jQuery("."+e).length)return jQuery("."+e).collapsible("closeAll")}},{key:"generateLabel",value:function(e,t,n){var r;return n=n||"col-xs-4 col-sm-4 col-md-3 col-lg-3",(r=document.createElement("label")).setAttribute("class",n+" control-label"),r.setAttribute("for",e),r.appendChild(document.createTextNode(t)),r}},{key:"generateInput",value:function(e,t,n,r,i,o,a,u){var l,d,s,c;return void 0!==i&&i||(i=""),void 0===o&&(o="hidden"),void 0===a&&(a=!1),void 0===u&&(u=!0),(d=document.createElement("div")).setAttribute("class","form-group"),o!==this.inputTypes.HIDDEN&&a&&d.appendChild(this.generateLabel(n+r,a)),(l=document.createElement("div")).setAttribute("class","col-xs-6 col-sm-6 col-md-7 col-lg-7"),(s=document.createElement("input")).setAttribute("type",o),s.setAttribute("name",t+"["+r+"]["+n+"]"),o!==this.inputTypes.HIDDEN&&(c=n+e+r,s.setAttribute("id",c),!0===u&&this.addToAutocomplete(c,t,n)),"checkbox"===o&&i&&s.setAttribute("checked","checked"),s.setAttribute("class","form-control"),"checkbox"!==o?s.setAttribute("value",i):s.setAttribute("value","1"),l.appendChild(s),d.appendChild(l),d}},{key:"generateEditor",value:function(e,t,n,r,i,o,a,u){var l,d,s,c,p;return void 0===i&&(i=""),void 0===o&&(o="hidden"),void 0===a&&(a=!1),(d=document.createElement("div")).setAttribute("class","form-group"),a&&d.appendChild(this.generateLabel(n+r,a,"col-xs-1")),(l=document.createElement("div")).setAttribute("class","col-xs-9"),(s=document.createElement("textarea")).setAttribute("name",t+"["+r+"]["+n+"]"),c=n+e+r,s.setAttribute("id",c),s.setAttribute("class","form-control"),s.appendChild(document.createTextNode(i)),l.appendChild(s),(p=document.createElement("script")).appendChild(document.createTextNode("tinymce.init({ selector: '#"+c+"', "+u+" });")),l.appendChild(p),d.appendChild(l),d}},{key:"generateOptions",value:function(e,t,n,i,r,o,a,u,l){var d,s,c,p,h,m,b,f,y,v,g;if(void 0===r&&(r=""),void 0===s&&(s=!1),i=i||t,o=o||"id",a=a||[],y=document.createDocumentFragment(),e.sort)for(e=e.sort(function(e,t){var n,r;return e[i]?t[i]?(n=e[i].toUpperCase(),(r=t[i].toUpperCase())<n?1:n<r?-1:0):1:-1}),d=a.map(function(e){return e.id}),l&&(e=e.filter(function(e){return-1===d.indexOf(e.id)})),c=0,m=e.length;c<m;c++){for(p in f=u,g=e[c])v=g[p],f=f.replace("{"+p+"}",v);r.length&&(f=g[r]+" - "+f),(b=document.createElement("option")).setAttribute("value",g[o]),b.appendChild(document.createTextNode(f)),String(g[o])===String(n)&&b.setAttribute("selected",!0),y.appendChild(b)}else for(h in e)f=g=e[h],(b=document.createElement("option")).setAttribute("value",h),b.appendChild(document.createTextNode(f)),String(h)===String(n)&&b.setAttribute("selected",!0),y.appendChild(b);return y}},{key:"generateDropdown",value:function(e,t,n,r,i,o,a,u,l,d,s,c,p,h){var m,b,f,y,v,g,A,C,E,x,T=this;return void 0===d&&(d=""),void 0===a&&(a=!1),void 0===u&&(u=!1),C=document.createElement("div"),m=document.createDocumentFragment(),x=n+e+r,C.setAttribute("class","form-group"),C.appendChild(this.generateLabel(x,i)),(b=document.createElement("div")).setAttribute("class","col-xs-6 col-sm-6 col-md-7 col-lg-7"),(E=document.createElement("select")).setAttribute("name",t+"["+r+"]["+s+"]"),E.appendChild(this.generateOptions(o,n,a,l,d,s,c,p,h)),E.setAttribute("id",x),E.setAttribute("class","form-control select2"),u&&((v=document.createElement("div")).setAttribute("class","form-group"),v.appendChild(this.generateLabel("filter"+r,this.translate("filter"))),(g=document.createElement("select")).setAttribute("id","filter"+r),A=o.filter(function(e,t,n){return!e[u]}),(f=document.createElement("option")).setAttribute("value",0),f.appendChild(document.createTextNode(this.translate("noFilter"))),g.appendChild(f),g.appendChild(this.generateOptions(A,n,null,l,d,s,null,p,h)),g.setAttribute("class","form-control"),(y=b.cloneNode()).appendChild(g),v.appendChild(y),m.appendChild(v),jQuery(g).on("change",function(){var e,t;return A=function(t,e,n){var r,i,o,a;if(0===(t=Number(t)))return e;if((r=e.filter(function(e){return t===Number(e[n])})).length)for(o=0,a=r.length;o<a;o++)i=r[o],r=r.concat(A(i.id,e,n));return r},e=jQuery(g),jQuery(E).empty(),t=A(e.val(),o,u),E.appendChild(T.generateOptions(t,n,a,l,d,s,null,p,h))})),b.appendChild(E),C.appendChild(b),m.appendChild(C),m}},{key:"generateDateInput",value:function(e,t,n,r,i,o,a){var u,l,d,s,c;return void 0===i&&(i=""),void 0===o&&(o="hidden"),void 0===a&&(a=!1),(l=document.createElement("div")).setAttribute("class","form-group"),a&&l.appendChild(this.generateLabel(n+r,a)),(u=document.createElement("div")).setAttribute("class","col-lg-5 input-group date"),(d=document.createElement("input")).setAttribute("class","form-control"),d.setAttribute("type",o),d.setAttribute("name",t+"["+r+"]["+n+"]"),d.setAttribute("value",i),(s=document.createElement("span")).setAttribute("class","input-group-addon"),(c=document.createElement("span")).setAttribute("class","glyphicon glyphicon-calendar"),s.appendChild(c),u.appendChild(d),u.appendChild(s),l.appendChild(u),$(u).datetimepicker({locale:"ru",viewMode:"years",format:"YYYY-MM-DD",keepInvalid:!0}),l}},{key:"generateOrder",value:function(e,t,n){var r,i,o,a,u,l;return a=document.createElement("div"),i=document.createDocumentFragment(),r="order-"+t,a.setAttribute("class","form-group"),a.appendChild(this.generateLabel(t+e+n,this.translate("order"))),(o=document.createElement("div")).setAttribute("class","col-lg-offset-1 col-lg-3 text-center"),(u=document.createElement("select")).setAttribute("name",t+"["+n+"][order]"),u.appendChild(this.orderOptions(n)),this.updateOrder(r,n),l=t+e+n,u.setAttribute("id",l),u.setAttribute("class","form-control "+r),o.appendChild(u),a.appendChild(o),i.appendChild(a),this.bindOrderListener(r),i}},{key:"orderOptions",value:function(e){var t,n,r,i,o;for(t=document.createDocumentFragment(),n=r=1,o=e;1<=o?r<=o:o<=r;n=1<=o?++r:--r)i=document.createElement("option"),n===e&&i.setAttribute("selected","selected"),i.setAttribute("value",n),i.appendChild(document.createTextNode(n)),t.appendChild(i);return t}},{key:"updateOrder",value:function(e,u){$("."+e).each(function(){var e,t,n,r,i,o,a;if((r=(e=$(this)).children("option").length)<u){for(a=[],t=n=i=r+1,o=u;i<=o?n<=o:o<=n;t=i<=o?++n:--n)a.push(e.append("<option>"+t+"</option>"));return a}})}},{key:"bindOrderListener",value:function(i){var o=this;return void 0===this.ordersListener[i]&&($("body").on("focus click","."+i,function(e){return o.ordersListener[i]=e.target.value}),$("body").on("change","."+i,function(t){var n,r;if(r=$(t.target),(n=o.ordersListener[i])!==r.val())return $("."+i).each(function(){var e;if((e=$(this)).val()===t.target.value&&!e.is(r))return e.val(n)})})),!0}},{key:"generateCollapsible",value:function(e,t,n){var r,i,o,a;return a="section_"+(o=e+n),(i=document.createElement("div")).setAttribute("id",a),i.setAttribute("class",e),i.appendChild(document.createTextNode(n+". "+t)),i.appendChild(document.createElement("span")),(r=document.createElement("div")).appendChild(document.createTextNode("x")),r.setAttribute("id","exit_"+o),r.setAttribute("class","polyfield-exit"),r.setAttribute("title",this.translate("deleteElement")),i.appendChild(r),this.bindClose(o),i}},{key:"generateContainer",value:function(e){var t,n;return(n=document.createElement("div")).setAttribute("class","content"),n.appendChild(document.createElement("div")),n.appendChild(e),(t=document.createElement("div")).setAttribute("class",""),t.appendChild(n),t}},{key:"appendTemplate",value:function(e){var t,n,r,i,o,a,u,l,d,s,c,p;if((d=this.models[e]).counter++,p="section_"+e+d.counter,o=this.generateCollapsible(e,d.label,d.counter),a=document.createElement("p"),d.order&&a.appendChild(this.generateOrder(e,d.name,d.counter)),void 0===d.attributeTypes.length)for(r in s=d.attributeTypes)t=s[r],n=null,"object"===(void 0===t?"undefined":_typeof(t))&&(n=t.data,t=t.type),l=function(){switch(!1){case t!==this.inputTypes.STRING:return this.generateInput(e,d.name,r,d.counter,"","text",d.attributeLabels[r],d.autocomplete);case t!==this.inputTypes.DATE:return this.generateDateInput(e,d.name,r,d.counter,"","text",d.attributeLabels[r]);case t!==this.inputTypes.TEXT:return this.generateEditor(e,d.name,r,d.counter,"","text",d.attributeLabels[r],d.editorConfig);case t!==this.inputTypes.HIDDEN:return this.generateInput(e,d.name,r,d.counter,"","hidden",d.attributeLabels[r]);case t!==this.inputTypes.BOOLEAN:return this.generateInput(e,d.name,r,d.counter,"","checkbox",d.attributeLabels[r]);case t!==this.inputTypes.DROPDOWN:return this.generateDropdown(e,d.name,r,d.counter,d.attributeLabels[r],n||d.dropdownValues,"",d.filterAttribute,d.sortAttribute,d.dropdownPrefixAttribute,r,d.dropdownUnique?d.exists:[],d.dropdownAttributeTemplate,d.excludeExistingValues);default:return document.createElement("div")}}.call(this),a.appendChild(l);else if(d.type===this.types.STRING||d.type===this.types.DATE)for(u in c=d.attributes)r=c[u],0<=v.call(d.dateAttributes,r)?a.appendChild(this.generateDateInput(e,d.name,r,d.counter,"","text",d.attributeLabels[r])):a.appendChild(this.generateInput(e,d.name,r,d.counter,"","text",d.attributeLabels[r],d.autocomplete));else d.type===this.types.DROPDOWN&&a.appendChild(this.generateDropdown(e,d.name,d.dropdownAttribute,d.counter,d.attributeLabels[d.dropdownAttribute],d.dropdownValues,"",d.filterAttribute,d.sortAttribute,d.dropdownPrefixAttribute,d.dropdownValueAttribute,d.dropdownUnique?d.exists:[],d.dropdownAttributeTemplate,d.excludeExistingValues));return(i=document.createDocumentFragment()).appendChild(o),i.appendChild(this.generateContainer(a)),document.getElementById("content_"+e).appendChild(i),jQuery("#"+p).collapsible({defaultOpen:p}),this.createSelect2(p),this.bindAutocomplete()}},{key:"appendExists",value:function(e){var t,n,r,i,o,a,u,l,d,s,c,p,h,m,b,f,y;if(!(p=this.models[e]).existsShowen){for(s=0,c=(m=p.exists).length;s<c;s++){if(h=m[s],p.counter++,y="section_"+e+p.counter,i=this.generateCollapsible(e,p.label,p.counter),a=document.createElement("p"),p.order&&a.appendChild(this.generateOrder(e,p.name,p.counter)),void 0===p.attributeTypes.length)for(r in b=p.attributeTypes)t=b[r],n=null,u=p.dropdownValueAttribute,"object"===(void 0===t?"undefined":_typeof(t))&&(n=t.data,u=r,t=t.type),d=function(){switch(!1){case t!==this.inputTypes.STRING:return this.generateInput(e,p.name,r,p.counter,h[r],"text",p.attributeLabels[r],p.autocomplete);case t!==this.inputTypes.DATE:return this.generateDateInput(e,p.name,r,p.counter,h[r],"text",p.attributeLabels[r]);case t!==this.inputTypes.TEXT:return this.generateEditor(e,p.name,r,p.counter,h[r],"text",p.attributeLabels[r],p.editorConfig);case t!==this.inputTypes.HIDDEN:return this.generateInput(e,p.name,r,p.counter,h[r],"hidden",p.attributeLabels[r]);case t!==this.inputTypes.BOOLEAN:return this.generateInput(e,p.name,r,p.counter,h[r],"checkbox",p.attributeLabels[r]);case t!==this.inputTypes.DROPDOWN:return this.generateDropdown(e,p.name,r,p.counter,p.attributeLabels[r],n||p.dropdownValues,h[u],p.filterAttribute,p.sortAttribute,p.dropdownPrefixAttribute,r,[],p.dropdownAttributeTemplate,p.excludeExistingValues);default:return document.createElement("div")}}.call(this),a.appendChild(d);else if(p.type===this.types.STRING||p.type===this.types.DATE||p.type===this.types.TEXT_BLOCK)for(l in f=p.attributes)r=f[l],0<=v.call(p.dateAttributes,r)?a.appendChild(this.generateDateInput(e,p.name,r,p.counter,h[r],"text",p.attributeLabels[r])):p.type===this.types.TEXT_BLOCK?a.appendChild(this.generateEditor(e,p.name,r,p.counter,h[r],"text",p.attributeLabels[r],p.editorConfig)):a.appendChild(this.generateInput(e,p.name,r,p.counter,h[r],"text",p.attributeLabels[r],p.autocomplete));else p.type===this.types.DROPDOWN&&a.appendChild(this.generateDropdown(e,p.name,p.dropdownAttribute,p.counter,p.attributeLabels[p.dropdownAttribute],p.dropdownValues,h[p.dropdownValueAttribute],p.filterAttribute,p.sortAttribute,p.dropdownPrefixAttribute,p.dropdownValueAttribute,[],p.dropdownAttributeTemplate,p.excludeExistingValues));(o=document.createDocumentFragment()).appendChild(i),o.appendChild(this.generateContainer(a)),document.getElementById("content_"+e).appendChild(o),jQuery("#"+y).collapsible({defaultOpen:y}),this.createSelect2(y),this.bindAutocomplete()}return p.existsShowen=!0}}},{key:"bindClose",value:function(e){var t=this;return jQuery("body").on("click","#exit_"+e,function(){if(confirm(t.translate("deleteConfirmation")))return jQuery("#section_"+e).next().remove(),jQuery("#section_"+e).remove()})}},{key:"addToAutocomplete",value:function(e,t,n){return this.completes.push({id:e,modelName:t,attribute:n})}},{key:"bindAutocomplete",value:function(){var e,t,n,r,i,o;for(e=0,t=(r=this.completes).length;e<t;e++)n=r[e],void 0===(i=jQuery("#"+n.id))&&console.error("Bad selector identifier gets for input autocomplete"),o=location.protocol+"//"+location.host+"/content/autocomplete",i.autocomplete({serviceUrl:o,noSuggestionNotice:this.translate("noResults"),deferRequestBy:200,params:{modelName:n.modelName,attributeName:n.attribute},triggerSelectOnValidInput:!1});return this.completes=[]}},{key:"createSelect2",value:function(e){return jQuery("#"+e).next().contents().find("select.select2").select2()}},{key:"setTranslation",value:function(e){return this.i18n=e}},{key:"translate",value:function(e){return void 0!==this.i18n[e]?this.i18n[e]:e}}]),t);function t(){_classCallCheck(this,t),jQuery("body").on("blur",'input[type="text"]',function(){return jQuery(this).val(jQuery(this).val().trim())}),this.i18n={}}return e.prototype.types={STRING:"string",DROPDOWN:"dropdown",DATE:"date",TEXT_BLOCK:"editor"},e.prototype.inputTypes={TEXT:"text",DATE:"date",STRING:"string",BOOLEAN:"boolean",DROPDOWN:"dropdown",SELECT2:"select2",HIDDEN:"hidden"},e.prototype.models={},e.prototype.completes=[],e.prototype.ordersListener={},e}.call(this),window.polyfield=new e}).call(void 0);