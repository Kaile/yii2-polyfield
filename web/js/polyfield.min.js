var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=(()=>{function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}})();function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(){var v=[].indexOf,e=function(){_createClass(t,[{key:"push",value:function(e){return"object"!==(void 0===e?"undefined":_typeof(e))?console.log("Bad identifier for polyfield "+e):(e.counter=0,e.existsShowen=!e.exists,this.models[e.id]=e,this.appendExists(e.id),this.bindEvent(e.id))}},{key:"bindEvent",value:function(e){var t=this;return void 0===this.models[e]?console.log("Can not find object for what need to bind event"):jQuery("#button_"+e).on("click",function(){return t.hideExcess(e),t.appendTemplate(e)})}},{key:"hideExcess",value:function(e){if(jQuery("."+e).length)return jQuery("."+e).collapsible("closeAll")}},{key:"generateLabel",value:function(e,t,n){var r;return n=n||"col-xs-4 col-sm-4 col-md-3 col-lg-3",(r=document.createElement("label")).setAttribute("class",n+" control-label"),r.setAttribute("for",e),r.appendChild(document.createTextNode(t)),r}},{key:"generateInput",value:function(e,t,n,r,i,o,a,u){var l,d;return void 0!==i&&i||(i=""),void 0===o&&(o="hidden"),void 0===a&&(a=!1),void 0===u&&(u=!0),(l=document.createElement("div")).setAttribute("class","form-group"),o!==this.inputTypes.HIDDEN&&a&&l.appendChild(this.generateLabel(n+r,a)),(a=document.createElement("div")).setAttribute("class","col-xs-6 col-sm-6 col-md-7 col-lg-7"),(d=document.createElement("input")).setAttribute("type",o),d.setAttribute("name",t+"["+r+"]["+n+"]"),o!==this.inputTypes.HIDDEN&&(d.setAttribute("id",e=n+e+r),!0===u)&&this.addToAutocomplete(e,t,n),"checkbox"===o&&i&&d.setAttribute("checked","checked"),d.setAttribute("class","form-control"),"checkbox"!==o?d.setAttribute("value",i):d.setAttribute("value","1"),a.appendChild(d),l.appendChild(a),l}},{key:"generateEditor",value:function(e,t,n,r,i,o,a,u){var l;return void 0===i&&(i=""),void 0===o&&(o="hidden"),void 0===a&&(a=!1),(o=document.createElement("div")).setAttribute("class","form-group"),a&&o.appendChild(this.generateLabel(n+r,a,"col-xs-1")),(a=document.createElement("div")).setAttribute("class","col-xs-9"),(l=document.createElement("textarea")).setAttribute("name",t+"["+r+"]["+n+"]"),l.setAttribute("id",t=n+e+r),l.setAttribute("class","form-control"),l.appendChild(document.createTextNode(i)),a.appendChild(l),n=document.createElement("script"),u=u.replace(/^\{/,'{"selector": "#'+t+'",'),n.appendChild(document.createTextNode("tinymce.init(JSON.parse('"+u+"'));")),a.appendChild(n),o.appendChild(a),o}},{key:"generateOptions",value:function(e,t,n,r,i,o,a,u,l){var d,s,c,p,m,h,b,f,y,v;if(void 0===i&&(i=""),r=r||t,o=o||"id",a=a||[],(f=document.createDocumentFragment()).appendChild(document.createElement("option")),a||f[0].setAttribute("selected",!0),e.sort)for(e=e.sort(function(e,t){return e[r]?!t[r]||(e=e[r].toUpperCase(),(t=t[r].toUpperCase())<e)?1:e<t?-1:0:-1}),d=a.map(function(e){return e.id}),s=0,m=(e=l?e.filter(function(e){return-1===d.indexOf(e.id)}):e).length;s<m;s++){for(c in b=u,v=e[s])y=v[c],b=b.replace("{"+c+"}",y);i.length&&(b=v[i]+" - "+b),(h=document.createElement("option")).setAttribute("value",v[o]),h.appendChild(document.createTextNode(b)),String(v[o])===String(n)&&h.setAttribute("selected",!0),f.appendChild(h)}else for(p in e)b=v=e[p],(h=document.createElement("option")).setAttribute("value",p),h.appendChild(document.createTextNode(b)),String(p)===String(n)&&h.setAttribute("selected",!0),f.appendChild(h);return f}},{key:"generateDropdown",value:function(e,t,n,r,i,o,a,u,l,d,s,c,p,m){var h,b,f,y,v,g=this;return void 0===d&&(d=""),void 0===a&&(a=!1),void 0===u&&(u=!1),y=document.createElement("div"),h=document.createDocumentFragment(),e=n+e+r,y.setAttribute("class","form-group"),y.appendChild(this.generateLabel(e,i)),(i=document.createElement("div")).setAttribute("class","col-xs-6 col-sm-6 col-md-7 col-lg-7"),(v=document.createElement("select")).setAttribute("name",t+"["+r+"]["+s+"]"),v.appendChild(this.generateOptions(o,n,a,l,d,s,c,p,m)),v.setAttribute("id",e),v.setAttribute("class","form-control select2"),u&&((t=document.createElement("div")).setAttribute("class","form-group"),t.appendChild(this.generateLabel("filter"+r,this.translate("filter"))),(b=document.createElement("select")).setAttribute("id","filter"+r),f=o.filter(function(e,t,n){return!e[u]}),(c=document.createElement("option")).setAttribute("value",0),c.appendChild(document.createTextNode(this.translate("noFilter"))),b.appendChild(c),b.appendChild(this.generateOptions(f,n,null,l,d,s,null,p,m)),b.setAttribute("class","form-control"),(e=i.cloneNode()).appendChild(b),t.appendChild(e),h.appendChild(t),jQuery(b).on("change",function(){var e;return f=function(t,e,n){var r,i,o,a;if(0===(t=Number(t)))return e;if((r=e.filter(function(e){return t===Number(e[n])})).length)for(o=0,a=r.length;o<a;o++)i=r[o],r=r.concat(f(i.id,e,n));return r},e=jQuery(b),jQuery(v).empty(),e=f(e.val(),o,u),v.appendChild(g.generateOptions(e,n,a,l,d,s,null,p,m))})),i.appendChild(v),y.appendChild(i),h.appendChild(y),h}},{key:"generateDateInput",value:function(e,t,n,r,i,o,a){var u,l;return void 0===i&&(i=""),void 0===o&&(o="hidden"),void 0===a&&(a=!1),(u=document.createElement("div")).setAttribute("class","form-group"),a&&u.appendChild(this.generateLabel(n+r,a)),(a=document.createElement("div")).setAttribute("class","col-lg-5 input-group date"),(l=document.createElement("input")).setAttribute("class","form-control"),l.setAttribute("type",o),l.setAttribute("name",t+"["+r+"]["+n+"]"),l.setAttribute("value",i),(o=document.createElement("span")).setAttribute("class","input-group-addon"),(t=document.createElement("span")).setAttribute("class","glyphicon glyphicon-calendar"),o.appendChild(t),a.appendChild(l),a.appendChild(o),u.appendChild(a),$(a).datetimepicker({locale:"ru",viewMode:"years",format:"YYYY-MM-DD",keepInvalid:!0}),u}},{key:"generateOrder",value:function(e,t,n){var r,i,o=document.createElement("div"),a=document.createDocumentFragment(),u="order-"+t;return o.setAttribute("class","form-group"),o.appendChild(this.generateLabel(t+e+n,this.translate("order"))),(r=document.createElement("div")).setAttribute("class","col-lg-offset-1 col-lg-3 text-center"),(i=document.createElement("select")).setAttribute("name",t+"["+n+"][order]"),i.appendChild(this.orderOptions(n)),this.updateOrder(u,n),i.setAttribute("id",t+e+n),i.setAttribute("class","form-control "+u),r.appendChild(i),o.appendChild(r),a.appendChild(o),this.bindOrderListener(u),a}},{key:"orderOptions",value:function(e){for(var t,n,r=document.createDocumentFragment(),i=t=1,o=e;1<=o?t<=o:o<=t;i=1<=o?++t:--t)n=document.createElement("option"),i===e&&n.setAttribute("selected","selected"),n.setAttribute("value",i),n.appendChild(document.createTextNode(i)),r.appendChild(n);return r}},{key:"updateOrder",value:function(e,u){$("."+e).each(function(){var e,t,n,r,i,o=$(this),a=o.children("option").length;if(a<u){for(i=[],e=t=n=a+1,r=u;n<=r?t<=r:r<=t;e=n<=r?++t:--t)i.push(o.append("<option>"+e+"</option>"));return i}})}},{key:"bindOrderListener",value:function(i){var o=this;return void 0===this.ordersListener[i]&&($("body").on("focus click","."+i,function(e){return o.ordersListener[i]=e.target.value}),$("body").on("change","."+i,function(t){var n=$(t.target),r=o.ordersListener[i];if(r!==n.val())return $("."+i).each(function(){var e=$(this);if(e.val()===t.target.value&&!e.is(n))return e.val(r)})})),!0}},{key:"generateCollapsible",value:function(e,t,n){var r=e+n,i="section_"+r,o=document.createElement("div");return o.setAttribute("id",i),o.setAttribute("class",e),o.appendChild(document.createTextNode(n+". "+t)),o.appendChild(document.createElement("span")),(i=document.createElement("div")).appendChild(document.createTextNode("x")),i.setAttribute("id","exit_"+r),i.setAttribute("class","polyfield-exit"),i.setAttribute("title",this.translate("deleteElement")),o.appendChild(i),this.bindClose(r),o}},{key:"generateContainer",value:function(e){var t=document.createElement("div");return t.setAttribute("class","content"),t.appendChild(document.createElement("div")),t.appendChild(e),(e=document.createElement("div")).setAttribute("class",""),e.appendChild(t),e}},{key:"appendTemplate",value:function(e){var t,n,r,i,o,a,u,l,d,s,c,p=this.models[e];if(p.counter++,c="section_"+e+p.counter,o=this.generateCollapsible(e,p.label,p.counter),a=document.createElement("p"),p.order&&a.appendChild(this.generateOrder(e,p.name,p.counter)),void 0===p.attributeTypes.length)for(r in d=p.attributeTypes)t=d[r],n=null,"object"===(void 0===t?"undefined":_typeof(t))&&(n=t.data,t=t.type),l=function(){switch(!1){case t!==this.inputTypes.STRING:return this.generateInput(e,p.name,r,p.counter,"","text",p.attributeLabels[r],p.autocomplete);case t!==this.inputTypes.DATE:return this.generateDateInput(e,p.name,r,p.counter,"","text",p.attributeLabels[r]);case t!==this.inputTypes.TEXT:return this.generateEditor(e,p.name,r,p.counter,"","text",p.attributeLabels[r],p.editorConfig);case t!==this.inputTypes.HIDDEN:return this.generateInput(e,p.name,r,p.counter,"","hidden",p.attributeLabels[r]);case t!==this.inputTypes.BOOLEAN:return this.generateInput(e,p.name,r,p.counter,"","checkbox",p.attributeLabels[r]);case t!==this.inputTypes.DROPDOWN:return this.generateDropdown(e,p.name,r,p.counter,p.attributeLabels[r],n||p.dropdownValues,"",p.filterAttribute,p.sortAttribute,p.dropdownPrefixAttribute,r,p.dropdownUnique?p.exists:[],p.dropdownAttributeTemplate,p.excludeExistingValues);default:return document.createElement("div")}}.call(this),a.appendChild(l);else if(p.type===this.types.STRING||p.type===this.types.DATE)for(u in s=p.attributes)r=s[u],0<=v.call(p.dateAttributes,r)?a.appendChild(this.generateDateInput(e,p.name,r,p.counter,"","text",p.attributeLabels[r])):a.appendChild(this.generateInput(e,p.name,r,p.counter,"","text",p.attributeLabels[r],p.autocomplete));else p.type===this.types.DROPDOWN&&a.appendChild(this.generateDropdown(e,p.name,p.dropdownAttribute,p.counter,p.attributeLabels[p.dropdownAttribute],p.dropdownValues,"",p.filterAttribute,p.sortAttribute,p.dropdownPrefixAttribute,p.dropdownValueAttribute,p.dropdownUnique?p.exists:[],p.dropdownAttributeTemplate,p.excludeExistingValues));return(i=document.createDocumentFragment()).appendChild(o),i.appendChild(this.generateContainer(a)),document.getElementById("content_"+e).appendChild(i),jQuery("#"+c).collapsible({defaultOpen:c}),this.createSelect2(c,p),this.bindAutocomplete()}},{key:"appendExists",value:function(e){var t,n,r,i,o,a,u,l,d,s,c,p,m,h,b,f,y=this.models[e];if(!y.existsShowen){for(s=0,c=(m=y.exists).length;s<c;s++){if(p=m[s],y.counter++,f="section_"+e+y.counter,i=this.generateCollapsible(e,y.label,y.counter),a=document.createElement("p"),y.order&&a.appendChild(this.generateOrder(e,y.name,y.counter)),void 0===y.attributeTypes.length)for(r in h=y.attributeTypes)t=h[r],n=null,u=y.dropdownValueAttribute,"object"===(void 0===t?"undefined":_typeof(t))&&(n=t.data,u=r,t=t.type),d=function(){switch(!1){case t!==this.inputTypes.STRING:return this.generateInput(e,y.name,r,y.counter,p[r],"text",y.attributeLabels[r],y.autocomplete);case t!==this.inputTypes.DATE:return this.generateDateInput(e,y.name,r,y.counter,p[r],"text",y.attributeLabels[r]);case t!==this.inputTypes.TEXT:return this.generateEditor(e,y.name,r,y.counter,p[r],"text",y.attributeLabels[r],y.editorConfig);case t!==this.inputTypes.HIDDEN:return this.generateInput(e,y.name,r,y.counter,p[r],"hidden",y.attributeLabels[r]);case t!==this.inputTypes.BOOLEAN:return this.generateInput(e,y.name,r,y.counter,p[r],"checkbox",y.attributeLabels[r]);case t!==this.inputTypes.DROPDOWN:return this.generateDropdown(e,y.name,r,y.counter,y.attributeLabels[r],n||y.dropdownValues,p[u],y.filterAttribute,y.sortAttribute,y.dropdownPrefixAttribute,r,[],y.dropdownAttributeTemplate,y.excludeExistingValues);default:return document.createElement("div")}}.call(this),a.appendChild(d);else if(y.type===this.types.STRING||y.type===this.types.DATE||y.type===this.types.TEXT_BLOCK)for(l in b=y.attributes)r=b[l],0<=v.call(y.dateAttributes,r)?a.appendChild(this.generateDateInput(e,y.name,r,y.counter,p[r],"text",y.attributeLabels[r])):y.type===this.types.TEXT_BLOCK?a.appendChild(this.generateEditor(e,y.name,r,y.counter,p[r],"text",y.attributeLabels[r],y.editorConfig)):a.appendChild(this.generateInput(e,y.name,r,y.counter,p[r],"text",y.attributeLabels[r],y.autocomplete));else y.type===this.types.DROPDOWN&&a.appendChild(this.generateDropdown(e,y.name,y.dropdownAttribute,y.counter,y.attributeLabels[y.dropdownAttribute],y.dropdownValues,p[y.dropdownValueAttribute],y.filterAttribute,y.sortAttribute,y.dropdownPrefixAttribute,y.dropdownValueAttribute,[],y.dropdownAttributeTemplate,y.excludeExistingValues));(o=document.createDocumentFragment()).appendChild(i),o.appendChild(this.generateContainer(a)),document.getElementById("content_"+e).appendChild(o),jQuery("#"+f).collapsible({defaultOpen:f}),this.createSelect2(f,y),this.bindAutocomplete()}return y.existsShowen=!0}}},{key:"bindClose",value:function(e){var t=this;return jQuery("body").on("click","#exit_"+e,function(){if(confirm(t.translate("deleteConfirmation")))return jQuery("#section_"+e).next().remove(),jQuery("#section_"+e).remove()})}},{key:"addToAutocomplete",value:function(e,t,n){return this.completes.push({id:e,modelName:t,attribute:n})}},{key:"bindAutocomplete",value:function(){for(var e,t,n,r=this.completes,i=0,o=r.length;i<o;i++)e=r[i],void 0===(t=jQuery("#"+e.id))&&console.error("Bad selector identifier gets for input autocomplete"),n=location.protocol+"//"+location.host+"/content/autocomplete",t.autocomplete({serviceUrl:n,noSuggestionNotice:this.translate("noResults"),deferRequestBy:200,params:{modelName:e.modelName,attributeName:e.attribute},triggerSelectOnValidInput:!1});return this.completes=[]}},{key:"createSelect2",value:function(e,t){var n={allowClear:!0};return t.dropdownDataUrl&&(n.ajax={url:t.dropdownDataUrl,data:function(e){return _defineProperty({},t.dropdownDataUrlSearchParam,e.term)},delay:400,dataType:"json"}),jQuery("#"+e).next().contents().find("select.select2").select2(n)}},{key:"setTranslation",value:function(e){return this.i18n=e}},{key:"translate",value:function(e){return void 0!==this.i18n[e]?this.i18n[e]:e}}]);var e=t;function t(){_classCallCheck(this,t),jQuery("body").on("blur",'input[type="text"]',function(){return jQuery(this).val(jQuery(this).val().trim())}),this.i18n={}}return e.prototype.types={STRING:"string",DROPDOWN:"dropdown",DATE:"date",TEXT_BLOCK:"editor"},e.prototype.inputTypes={TEXT:"text",DATE:"date",STRING:"string",BOOLEAN:"boolean",DROPDOWN:"dropdown",SELECT2:"select2",HIDDEN:"hidden"},e.prototype.models={},e.prototype.completes=[],e.prototype.ordersListener={},e}.call(this);window.polyfield=new e}.call(void 0);