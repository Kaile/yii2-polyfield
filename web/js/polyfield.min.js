var Polyfield,indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};Polyfield=(function(){a.prototype.types={STRING:"string",DROPDOWN:"dropdown",DATE:"date",TEXT_BLOCK:"editor"};a.prototype.inputTypes={TEXT:"text",DATE:"date",STRING:"string",BOOLEAN:"boolean",DROPDOWN:"dropdown"};function a(){jQuery("body").on("blur",'input[type="text"]',function(){return jQuery(this).val(jQuery(this).val().trim())});this.i18n={}}a.prototype.models={};a.prototype.completes=[];a.prototype.ordersListener={};a.prototype.push=function(b){if(typeof b!=="object"){return console.log("Bad identifier for polyfield "+b)}b.counter=0;b.existsShowen=b.exists?false:true;this.models[b.id]=b;this.appendExists(b.id);return this.bindEvent(b.id)};a.prototype.bindEvent=function(c){var b;if(typeof this.models[c]==="undefined"){return console.log("Can not find object for what need to bind event")}b=jQuery("#button_"+c);return b.on("click",(function(d){return function(){d.hideExcess(c);return d.appendTemplate(c)}})(this))};a.prototype.hideExcess=function(b){if(jQuery("."+b).length){return jQuery("."+b).collapsible("closeAll")}};a.prototype.generateLabel=function(b,e,c){var d;c=c||"col-xs-4 col-sm-4 col-md-3 col-lg-3";d=document.createElement("label");d.setAttribute("class",c+" control-label");d.setAttribute("for",b);d.appendChild(document.createTextNode(e));return d};a.prototype.generateInput=function(e,g,f,c,l,h,j){var d,b,i,k;if(typeof l==="undefined"||!l){l=""}if(typeof h==="undefined"){h="hidden"}if(typeof j==="undefined"){j=false}b=document.createElement("div");b.setAttribute("class","form-group");if(j){b.appendChild(this.generateLabel(f+c,j))}d=document.createElement("div");d.setAttribute("class","col-xs-6 col-sm-6 col-md-7 col-lg-7");i=document.createElement("input");i.setAttribute("type",h);i.setAttribute("name",g+"["+c+"]["+f+"]");if(h!=="hidden"){k=f+e+c;i.setAttribute("id",k);this.addToAutocomplete(k,g,f)}if(h==="checkbox"&&l){i.setAttribute("checked","checked")}i.setAttribute("class","form-control");if(h!=="checkbox"){i.setAttribute("value",l)}else{i.setAttribute("value","1")}d.appendChild(i);b.appendChild(d);return b};a.prototype.generateEditor=function(e,h,f,c,n,i,l){var d,b,k,m,j,o,g;if(typeof n==="undefined"){n=""}if(typeof i==="undefined"){i="hidden"}if(typeof l==="undefined"){l=false}b=document.createElement("div");b.setAttribute("class","form-group");if(l){b.appendChild(this.generateLabel(f+c,l,"col-xs-1"))}d=document.createElement("div");d.setAttribute("class","col-xs-9");k=document.createElement("textarea");k.setAttribute("name",h+"["+c+"]["+f+"]");m=f+e+c;k.setAttribute("id",m);k.setAttribute("class","form-control");k.appendChild(document.createTextNode(n));d.appendChild(k);if(typeof tinymce==="undefined"){g=document.createElement("script");g.setAttribute("src","tinymce/timymce.min.js");body.appendChild(g);o=document.createElement("script");o.setAttribute("src","tinymce/langs/ru.js");body.appendChild(o)}j=document.createElement("script");j.appendChild(document.createTextNode("tinymce.init({ selector: '#"+m+"', language: 'ru', height: 300, fontsize_formats: '6pt 7pt 8pt 9pt 10pt 11pt 12pt 13pt 14pt 15pt 16pt 18pt 20pt 24pt 28pt 36pt 40pt 48pt', plugins: [ 'advlist autolink lists link image charmap print preview hr anchor pagebreak', 'searchreplace wordcount visualblocks visualchars code fullscreen', 'insertdatetime media nonbreaking save table contextmenu directionality', 'emoticons template paste textcolor quotes' ], toolbar: [ 'undo redo | fontsizeselect | bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | forecolor backcolor | print preview media' ], image_advtab: true, image_class_list: [ {title: 'Без масштабирования', value: 'no-scale-image'}, {title: 'С масштабированием', value: 'scale-image'} ] });"));d.appendChild(j);b.appendChild(d);return b};a.prototype.generateOptions=function(n,c,e,d,i,l){var b,f,h,g,k,o,m;if(typeof i==="undefined"){i=""}if(typeof b==="undefined"){b=false}d=d||c;if(!l){l="id"}o=document.createDocumentFragment();n=n.sort(function(p,j){var r,q;if(!p[d]){return -1}if(!j[d]){return 1}r=p[d].toUpperCase();q=j[d].toUpperCase();if(r>q){return 1}if(r<q){return -1}return 0});for(f=0,h=n.length;f<h;f++){m=n[f];k=m[c];if(i.length){k=m[i]+" - "+k}g=document.createElement("option");g.setAttribute("value",m[l]);g.appendChild(document.createTextNode(k));if(m[l]===e){g.setAttribute("selected",true)}o.appendChild(g)}return o};a.prototype.generateDropdown=function(q,p,n,k,j,d,s,u,v,t,h){var e,o,m,l,b,i,g,f,r,c;if(typeof t==="undefined"){t=""}if(typeof s==="undefined"){s=false}if(typeof u==="undefined"){u=false}f=document.createElement("div");e=document.createDocumentFragment();f.setAttribute("class","form-group");f.appendChild(this.generateLabel(n+k,j));o=document.createElement("div");o.setAttribute("class","col-xs-6 col-sm-6 col-md-7 col-lg-7");r=document.createElement("select");r.setAttribute("name",p+"["+k+"][id]");r.appendChild(this.generateOptions(d,n,s,v,t,h));c=n+q+k;r.setAttribute("id",c);r.setAttribute("class","form-control");if(u){b=document.createElement("div");b.setAttribute("class","form-group");b.appendChild(this.generateLabel("filter"+k,this.translate("filter")));i=document.createElement("select");i.setAttribute("id","filter"+k);g=d.filter(function(x,w,y){return !x[u]});m=document.createElement("option");m.setAttribute("value",0);m.appendChild(document.createTextNode(this.translate("noFilter")));i.appendChild(m);i.appendChild(this.generateOptions(g,n,null,v,t,h));i.setAttribute("class","form-control");l=o.cloneNode();l.appendChild(i);b.appendChild(l);e.appendChild(b);jQuery(i).on("change",(function(w){return function(){var z,y,x;g=function(G,C,B){var E,F,D,A;G=Number(G);if(G===0){return C}else{E=C.filter(function(H){if(G===Number(H[B])){return true}else{return false}});if(E.length){for(D=0,A=E.length;D<A;D++){F=E[D];E=E.concat(g(F.id,C,B))}}return E}};z=jQuery(i);y=jQuery(r);y.empty();x=g(z.val(),d,u);return r.appendChild(w.generateOptions(x,n,s,v,t,h))}})(this))}o.appendChild(r);f.appendChild(o);e.appendChild(f);return e};a.prototype.generateDateInput=function(d,h,e,c,m,i,l){var j,b,k,g,f;if(typeof m==="undefined"){m=""}if(typeof i==="undefined"){i="hidden"}if(typeof l==="undefined"){l=false}b=document.createElement("div");b.setAttribute("class","form-group");if(l){b.appendChild(this.generateLabel(e+c,l))}j=document.createElement("div");j.setAttribute("class","col-lg-5 input-group date");k=document.createElement("input");k.setAttribute("class","form-control");k.setAttribute("type",i);k.setAttribute("name",h+"["+c+"]["+e+"]");k.setAttribute("value",m);g=document.createElement("span");g.setAttribute("class","input-group-addon");f=document.createElement("span");f.setAttribute("class","glyphicon glyphicon-calendar");g.appendChild(f);j.appendChild(k);j.appendChild(g);b.appendChild(j);$(j).datetimepicker({locale:"ru",viewMode:"years",format:"YYYY-MM-DD"});return b};a.prototype.generateOrder=function(j,h,c){var f,g,d,b,i,e;b=document.createElement("div");g=document.createDocumentFragment();f="order-"+h;b.setAttribute("class","form-group");b.appendChild(this.generateLabel(h+j+c,this.translate("order")));d=document.createElement("div");d.setAttribute("class","col-lg-offset-1 col-lg-3 text-center");i=document.createElement("select");i.setAttribute("name",h+"["+c+"][order]");i.appendChild(this.orderOptions(c));this.updateOrder(f,c);e=h+j+c;i.setAttribute("id",e);i.setAttribute("class","form-control "+f);d.appendChild(i);b.appendChild(d);g.appendChild(b);this.bindOrderListener(f);return g};a.prototype.orderOptions=function(b){var d,e,c,f,g;d=document.createDocumentFragment();for(e=c=1,g=b;1<=g?c<=g:c>=g;e=1<=g?++c:--c){f=document.createElement("option");if(e===b){f.setAttribute("selected","selected")}f.setAttribute("value",e);f.appendChild(document.createTextNode(e));d.appendChild(f)}return d};a.prototype.updateOrder=function(d,b){var c;c=$("."+d);c.each(function(){var m,k,g,f,l,e,h;m=$(this);f=m.children("option").length;if(f<b){h=[];for(k=g=l=f+1,e=b;l<=e?g<=e:g>=e;k=l<=e?++g:--g){h.push(m.append("<option>"+k+"</option>"))}return h}})};a.prototype.bindOrderListener=function(b){if(typeof this.ordersListener[b]==="undefined"){$("body").on("focus click","."+b,(function(c){return function(d){return c.ordersListener[b]=d.target.value}})(this));$("body").on("change","."+b,(function(c){return function(f){var g,d;d=$(f.target);g=c.ordersListener[b];if(g!==d.val()){return $("."+b).each(function(){var e;e=$(this);if(e.val()===f.target.value&&!e.is(d)){return e.val(g)}})}}})(this))}return true};a.prototype.generateCollapsible=function(h,c,b){var g,f,d,e;d=h+b;e="section_"+d;f=document.createElement("div");f.setAttribute("id",e);f.setAttribute("class",h);f.appendChild(document.createTextNode(b+". "+c));f.appendChild(document.createElement("span"));g=document.createElement("div");g.appendChild(document.createTextNode("x"));g.setAttribute("id","exit_"+d);g.setAttribute("class","polyfield-exit");g.setAttribute("title",this.translate("deleteElement"));f.appendChild(g);this.bindClose(d);return f};a.prototype.generateContainer=function(c){var b,d;d=document.createElement("div");d.setAttribute("class","content");d.appendChild(document.createElement("div"));d.appendChild(c);b=document.createElement("div");b.setAttribute("class","");b.appendChild(d);return b};a.prototype.appendTemplate=function(b){var e,c,l,m,i,g,j,f,d,h,k;f=this.models[b];f.counter++;k="section_"+b+f.counter;m=this.generateCollapsible(b,f.label,f.counter);i=document.createElement("p");if(f.order){i.appendChild(this.generateOrder(b,f.name,f.counter))}if(f.attributeTypes){d=f.attributeTypes;for(c in d){e=d[c];j=(function(){switch(false){case e!==this.inputTypes.STRING:return this.generateInput(b,f.name,c,f.counter,"","text",f.attributeLabels[c]);case e!==this.inputTypes.DATE:return this.generateDateInput(b,f.name,c,f.counter,"","text",f.attributeLabels[c]);case e!==this.inputTypes.TEXT:return this.generateEditor(b,f.name,c,f.counter,"","text",f.attributeLabels[c]);case e!==this.inputTypes.BOOLEAN:return this.generateInput(b,f.name,c,f.counter,"","checkbox",f.attributeLabels[c]);case e!==this.inputTypes.DROPDOWN:return this.generateDropdown(b,f.name,f.dropdownAttribute,f.counter,f.attributeLabels[f.dropdownAttribute],f.dropdownValues,"",f.filterAttribute,f.sortAttribute,f.dropdownPrefixAttribute,f.dropdownValueAttribute);default:return document.createElement("div")}}).call(this);i.appendChild(j)}}else{if(f.type===this.types.STRING||f.type===this.types.DATE){h=f.attributes;for(g in h){c=h[g];if(indexOf.call(f.dateAttributes,c)>=0){i.appendChild(this.generateDateInput(b,f.name,c,f.counter,"","text",f.attributeLabels[c]));continue}else{i.appendChild(this.generateInput(b,f.name,c,f.counter,"","text",f.attributeLabels[c]))}}}else{if(f.type===this.types.DROPDOWN){i.appendChild(this.generateDropdown(b,f.name,f.dropdownAttribute,f.counter,f.attributeLabels[f.dropdownAttribute],f.dropdownValues,"",f.filterAttribute,f.sortAttribute,f.dropdownPrefixAttribute,f.dropdownValueAttribute))}}}l=document.createDocumentFragment();l.appendChild(m);l.appendChild(this.generateContainer(i));document.getElementById("content_"+b).appendChild(l);jQuery("#"+k).collapsible({defaultOpen:""+k});return this.bindAutocomplete()};a.prototype.appendExists=function(b){var e,c,r,h,o,m,p,g,l,i,f,d,n,k,q;i=this.models[b];if(i.existsShowen){return}d=i.exists;for(g=0,l=d.length;g<l;g++){f=d[g];i.counter++;q="section_"+b+i.counter;r=this.generateCollapsible(b,i.label,i.counter);o=document.createElement("p");if(i.order){o.appendChild(this.generateOrder(b,i.name,i.counter))}if(i.attributeTypes){n=i.attributeTypes;for(c in n){e=n[c];p=(function(){switch(false){case e!==this.inputTypes.STRING:return this.generateInput(b,i.name,c,i.counter,f[c],"text",i.attributeLabels[c]);case e!==this.inputTypes.DATE:return this.generateDateInput(b,i.name,c,i.counter,f[c],"text",i.attributeLabels[c]);case e!==this.inputTypes.TEXT:return this.generateEditor(b,i.name,c,i.counter,f[c],"text",i.attributeLabels[c]);case e!==this.inputTypes.BOOLEAN:return this.generateInput(b,i.name,c,i.counter,f[c],"checkbox",i.attributeLabels[c]);case e!==this.inputTypes.DROPDOWN:return this.generateDropdown(b,i.name,i.dropdownAttribute,i.counter,i.attributeLabels[i.dropdownAttribute],i.dropdownValues,f[i.dropdownValueAttribute],i.filterAttribute,i.sortAttribute,i.dropdownPrefixAttribute,i.dropdownValueAttribute);default:return document.createElement("div")}}).call(this);o.appendChild(p)}}else{if(i.type===this.types.STRING||i.type===this.types.DATE||i.type===this.types.TEXT_BLOCK){k=i.attributes;for(m in k){c=k[m];if(indexOf.call(i.dateAttributes,c)>=0){o.appendChild(this.generateDateInput(b,i.name,c,i.counter,f[c],"text",i.attributeLabels[c]));continue}else{if(i.type===this.types.TEXT_BLOCK){o.appendChild(this.generateEditor(b,i.name,c,i.counter,f[c],"text",i.attributeLabels[c]))}else{o.appendChild(this.generateInput(b,i.name,c,i.counter,f[c],"text",i.attributeLabels[c]))}}}}else{if(i.type===this.types.DROPDOWN){o.appendChild(this.generateDropdown(b,i.name,i.dropdownAttribute,i.counter,i.attributeLabels[i.dropdownAttribute],i.dropdownValues,f[i.dropdownValueAttribute],i.filterAttribute,i.sortAttribute,i.dropdownPrefixAttribute,i.dropdownValueAttribute))}}}h=document.createDocumentFragment();h.appendChild(r);h.appendChild(this.generateContainer(o));document.getElementById("content_"+b).appendChild(h);jQuery("#"+q).collapsible({defaultOpen:q});this.bindAutocomplete()}return i.existsShowen=true};a.prototype.bindClose=function(b){return jQuery("body").on("click","#exit_"+b,(function(c){return function(){if(confirm(c.translate("deleteConfirmation"))){jQuery("#section_"+b).next().remove();return jQuery("#section_"+b).remove()}}})(this))};a.prototype.addToAutocomplete=function(c,b,d){return this.completes.push({id:c,modelName:b,attribute:d})};a.prototype.bindAutocomplete=function(){var f,c,e,g,b,d;g=this.completes;for(f=0,c=g.length;f<c;f++){e=g[f];b=jQuery("#"+e.id);if(typeof b==="undefined"){console.error("Bad selector identifier gets for input autocomplete")}d=location.protocol+"//"+location.host+"/content/autocomplete";b.autocomplete({serviceUrl:d,noSuggestionNotice:this.translate("noResults"),deferRequestBy:200,params:{modelName:e.modelName,attributeName:e.attribute}})}return this.completes=[]};a.prototype.setTranslation=function(b){return this.i18n=b};a.prototype.translate=function(b){if(typeof this.i18n[b]!=="undefined"){return this.i18n[b]}else{return b}};return a})();window.polyfield=new Polyfield();