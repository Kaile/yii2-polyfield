"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();(function(){var e,t=[].indexOf;e=function(){var e=function(){function e(){_classCallCheck(this,e),jQuery("body").on("blur",'input[type="text"]',function(){return jQuery(this).val(jQuery(this).val().trim())}),this.i18n={}}return _createClass(e,[{key:"push",value:function(e){return"object"!==("undefined"==typeof e?"undefined":_typeof(e))?console.log("Bad identifier for polyfield "+e):(e.counter=0,e.existsShowen=!e.exists,this.models[e.id]=e,this.appendExists(e.id),this.bindEvent(e.id))}},{key:"bindEvent",value:function(e){var t,n=this;return"undefined"==typeof this.models[e]?console.log("Can not find object for what need to bind event"):(t=jQuery("#button_"+e),t.on("click",function(){return n.hideExcess(e),n.appendTemplate(e)}))}},{key:"hideExcess",value:function(e){if(jQuery("."+e).length)return jQuery("."+e).collapsible("closeAll")}},{key:"generateLabel",value:function(e,t,n){var r;return n=n||"col-xs-4 col-sm-4 col-md-3 col-lg-3",r=document.createElement("label"),r.setAttribute("class",n+" control-label"),r.setAttribute("for",e),r.appendChild(document.createTextNode(t)),r}},{key:"generateInput",value:function(e,t,n,r,i,a,o){var u,l,d,s;return"undefined"!=typeof i&&i||(i=""),"undefined"==typeof a&&(a="hidden"),"undefined"==typeof o&&(o=!1),l=document.createElement("div"),l.setAttribute("class","form-group"),a!==this.inputTypes.HIDDEN&&o&&l.appendChild(this.generateLabel(n+r,o)),u=document.createElement("div"),u.setAttribute("class","col-xs-6 col-sm-6 col-md-7 col-lg-7"),d=document.createElement("input"),d.setAttribute("type",a),d.setAttribute("name",t+"["+r+"]["+n+"]"),a!==this.inputTypes.HIDDEN&&(s=n+e+r,d.setAttribute("id",s),this.addToAutocomplete(s,t,n)),"checkbox"===a&&i&&d.setAttribute("checked","checked"),d.setAttribute("class","form-control"),"checkbox"!==a?d.setAttribute("value",i):d.setAttribute("value","1"),u.appendChild(d),l.appendChild(u),l}},{key:"generateEditor",value:function(e,t,n,r,i,a,o){var u,l,d,s,c;return"undefined"==typeof i&&(i=""),"undefined"==typeof a&&(a="hidden"),"undefined"==typeof o&&(o=!1),l=document.createElement("div"),l.setAttribute("class","form-group"),o&&l.appendChild(this.generateLabel(n+r,o,"col-xs-1")),u=document.createElement("div"),u.setAttribute("class","col-xs-9"),d=document.createElement("textarea"),d.setAttribute("name",t+"["+r+"]["+n+"]"),s=n+e+r,d.setAttribute("id",s),d.setAttribute("class","form-control"),d.appendChild(document.createTextNode(i)),u.appendChild(d),c=document.createElement("script"),c.appendChild(document.createTextNode("tinymce.init({ selector: '#"+s+"', language: 'ru', relative_urls: false, remove_script_host: false, height: 300, fontsize_formats: '6pt 7pt 8pt 9pt 10pt 11pt 12pt 13pt 14pt 15pt 16pt 18pt 20pt 24pt 28pt 36pt 40pt 48pt', plugins: [ 'advlist autolink lists link image charmap print preview hr anchor pagebreak', 'searchreplace wordcount visualblocks visualchars code fullscreen', 'insertdatetime media nonbreaking save table contextmenu directionality', 'emoticons template paste textcolor quotes insertfbframe' ], toolbar: [ 'undo redo | fontsizeselect | bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | forecolor backcolor | print preview media frame' ], image_advtab: true, image_class_list: [ {title: 'Без масштабирования', value: 'no-scale-image'}, {title: 'С масштабированием', value: 'scale-image'} ], image_caption: true });")),u.appendChild(c),l.appendChild(u),l}},{key:"generateOptions",value:function(e,t,n,r,i,a,o){var u,l,d,s,c,p,m,h,f;if("undefined"==typeof i&&(i=""),"undefined"==typeof l&&(l=!1),r=r||t,a||(a="id"),o||(o=[]),h=document.createDocumentFragment(),e.sort)for(e=e.sort(function(e,t){var n,i;return e[r]?t[r]?(n=e[r].toUpperCase(),i=t[r].toUpperCase(),n>i?1:n<i?-1:0):1:-1}),u=o.map(function(e){return e[t]}),e=e.filter(function(e){return u.indexOf(e[t])===-1}),d=0,c=e.length;d<c;d++)f=e[d],m=f[t],i.length&&(m=f[i]+" - "+m),p=document.createElement("option"),p.setAttribute("value",f[a]),p.appendChild(document.createTextNode(m)),f[a]===n&&p.setAttribute("selected",!0),h.appendChild(p);else for(s in e)f=e[s],m=f,p=document.createElement("option"),p.setAttribute("value",s),p.appendChild(document.createTextNode(m)),s===n&&p.setAttribute("selected",!0),h.appendChild(p);return h}},{key:"generateDropdown",value:function(e,t,n,r,i,a,o,u,l,d,s,c){var p,m,h,f,b,y,g,v,A,C,E=this;return"undefined"==typeof d&&(d=""),"undefined"==typeof o&&(o=!1),"undefined"==typeof u&&(u=!1),v=document.createElement("div"),p=document.createDocumentFragment(),C=n+e+r,v.setAttribute("class","form-group"),v.appendChild(this.generateLabel(C,i)),m=document.createElement("div"),m.setAttribute("class","col-xs-6 col-sm-6 col-md-7 col-lg-7"),A=document.createElement("select"),A.setAttribute("name",t+"["+r+"]["+s+"]"),A.appendChild(this.generateOptions(a,n,o,l,d,s,c)),A.setAttribute("id",C),A.setAttribute("class","form-control"),u&&(b=document.createElement("div"),b.setAttribute("class","form-group"),b.appendChild(this.generateLabel("filter"+r,this.translate("filter"))),y=document.createElement("select"),y.setAttribute("id","filter"+r),g=a.filter(function(e,t,n){return!e[u]}),h=document.createElement("option"),h.setAttribute("value",0),h.appendChild(document.createTextNode(this.translate("noFilter"))),y.appendChild(h),y.appendChild(this.generateOptions(g,n,null,l,d,s)),y.setAttribute("class","form-control"),f=m.cloneNode(),f.appendChild(y),b.appendChild(f),p.appendChild(b),jQuery(y).on("change",function(){var e,t,r;return g=function(e,t,n){var r,i,a,o;if(e=Number(e),0===e)return t;if(r=t.filter(function(t){return e===Number(t[n])}),r.length)for(a=0,o=r.length;a<o;a++)i=r[a],r=r.concat(g(i.id,t,n));return r},e=jQuery(y),t=jQuery(A),t.empty(),r=g(e.val(),a,u),A.appendChild(E.generateOptions(r,n,o,l,d,s))})),m.appendChild(A),v.appendChild(m),p.appendChild(v),p}},{key:"generateDateInput",value:function(e,t,n,r,i,a,o){var u,l,d,s,c;return"undefined"==typeof i&&(i=""),"undefined"==typeof a&&(a="hidden"),"undefined"==typeof o&&(o=!1),l=document.createElement("div"),l.setAttribute("class","form-group"),o&&l.appendChild(this.generateLabel(n+r,o)),u=document.createElement("div"),u.setAttribute("class","col-lg-5 input-group date"),d=document.createElement("input"),d.setAttribute("class","form-control"),d.setAttribute("type",a),d.setAttribute("name",t+"["+r+"]["+n+"]"),d.setAttribute("value",i),s=document.createElement("span"),s.setAttribute("class","input-group-addon"),c=document.createElement("span"),c.setAttribute("class","glyphicon glyphicon-calendar"),s.appendChild(c),u.appendChild(d),u.appendChild(s),l.appendChild(u),$(u).datetimepicker({locale:"ru",viewMode:"years",format:"YYYY-MM-DD",keepInvalid:!0}),l}},{key:"generateOrder",value:function(e,t,n){var r,i,a,o,u,l;return o=document.createElement("div"),i=document.createDocumentFragment(),r="order-"+t,o.setAttribute("class","form-group"),o.appendChild(this.generateLabel(t+e+n,this.translate("order"))),a=document.createElement("div"),a.setAttribute("class","col-lg-offset-1 col-lg-3 text-center"),u=document.createElement("select"),u.setAttribute("name",t+"["+n+"][order]"),u.appendChild(this.orderOptions(n)),this.updateOrder(r,n),l=t+e+n,u.setAttribute("id",l),u.setAttribute("class","form-control "+r),a.appendChild(u),o.appendChild(a),i.appendChild(o),this.bindOrderListener(r),i}},{key:"orderOptions",value:function(e){var t,n,r,i,a;for(t=document.createDocumentFragment(),n=r=1,a=e;1<=a?r<=a:r>=a;n=1<=a?++r:--r)i=document.createElement("option"),n===e&&i.setAttribute("selected","selected"),i.setAttribute("value",n),i.appendChild(document.createTextNode(n)),t.appendChild(i);return t}},{key:"updateOrder",value:function(e,t){var n;n=$("."+e),n.each(function(){var e,n,r,i,a,o,u;if(e=$(this),i=e.children("option").length,i<t){for(u=[],n=r=a=i+1,o=t;a<=o?r<=o:r>=o;n=a<=o?++r:--r)u.push(e.append("<option>"+n+"</option>"));return u}})}},{key:"bindOrderListener",value:function(e){var t=this;return"undefined"==typeof this.ordersListener[e]&&($("body").on("focus click","."+e,function(n){return t.ordersListener[e]=n.target.value}),$("body").on("change","."+e,function(n){var r,i;if(i=$(n.target),r=t.ordersListener[e],r!==i.val())return $("."+e).each(function(){var e;if(e=$(this),e.val()===n.target.value&&!e.is(i))return e.val(r)})})),!0}},{key:"generateCollapsible",value:function(e,t,n){var r,i,a,o;return a=e+n,o="section_"+a,i=document.createElement("div"),i.setAttribute("id",o),i.setAttribute("class",e),i.appendChild(document.createTextNode(n+". "+t)),i.appendChild(document.createElement("span")),r=document.createElement("div"),r.appendChild(document.createTextNode("x")),r.setAttribute("id","exit_"+a),r.setAttribute("class","polyfield-exit"),r.setAttribute("title",this.translate("deleteElement")),i.appendChild(r),this.bindClose(a),i}},{key:"generateContainer",value:function(e){var t,n;return n=document.createElement("div"),n.setAttribute("class","content"),n.appendChild(document.createElement("div")),n.appendChild(e),t=document.createElement("div"),t.setAttribute("class",""),t.appendChild(n),t}},{key:"appendTemplate",value:function(e){var n,r,i,a,o,u,l,d,s,c,p,m;if(s=this.models[e],s.counter++,m="section_"+e+s.counter,o=this.generateCollapsible(e,s.label,s.counter),u=document.createElement("p"),s.order&&u.appendChild(this.generateOrder(e,s.name,s.counter)),"undefined"==typeof s.attributeTypes.length){c=s.attributeTypes;for(i in c)n=c[i],r=null,"object"===("undefined"==typeof n?"undefined":_typeof(n))&&(r=n.data,n=n.type),d=function(){switch(!1){case n!==this.inputTypes.STRING:return this.generateInput(e,s.name,i,s.counter,"","text",s.attributeLabels[i]);case n!==this.inputTypes.DATE:return this.generateDateInput(e,s.name,i,s.counter,"","text",s.attributeLabels[i]);case n!==this.inputTypes.TEXT:return this.generateEditor(e,s.name,i,s.counter,"","text",s.attributeLabels[i]);case n!==this.inputTypes.HIDDEN:return this.generateInput(e,s.name,i,s.counter,"","hidden",s.attributeLabels[i]);case n!==this.inputTypes.BOOLEAN:return this.generateInput(e,s.name,i,s.counter,"","checkbox",s.attributeLabels[i]);case n!==this.inputTypes.DROPDOWN:return this.generateDropdown(e,s.name,i,s.counter,s.attributeLabels[i],r||s.dropdownValues,"",s.filterAttribute,s.sortAttribute,s.dropdownPrefixAttribute,i,s.dropdownUnique?s.exists:[]);default:return document.createElement("div")}}.call(this),u.appendChild(d)}else if(s.type===this.types.STRING||s.type===this.types.DATE){p=s.attributes;for(l in p)i=p[l],t.call(s.dateAttributes,i)>=0?u.appendChild(this.generateDateInput(e,s.name,i,s.counter,"","text",s.attributeLabels[i])):u.appendChild(this.generateInput(e,s.name,i,s.counter,"","text",s.attributeLabels[i]))}else s.type===this.types.DROPDOWN&&u.appendChild(this.generateDropdown(e,s.name,s.dropdownAttribute,s.counter,s.attributeLabels[s.dropdownAttribute],s.dropdownValues,"",s.filterAttribute,s.sortAttribute,s.dropdownPrefixAttribute,s.dropdownValueAttribute,s.dropdownUnique?s.exists:[]));return a=document.createDocumentFragment(),a.appendChild(o),a.appendChild(this.generateContainer(u)),document.getElementById("content_"+e).appendChild(a),jQuery("#"+m).collapsible({defaultOpen:""+m}),this.createSelect2(m),this.bindAutocomplete()}},{key:"appendExists",value:function(e){var n,r,i,a,o,u,l,d,s,c,p,m,h,f,b,y;if(p=this.models[e],!p.existsShowen){for(h=p.exists,s=0,c=h.length;s<c;s++){if(m=h[s],p.counter++,y="section_"+e+p.counter,a=this.generateCollapsible(e,p.label,p.counter),u=document.createElement("p"),p.order&&u.appendChild(this.generateOrder(e,p.name,p.counter)),"undefined"==typeof p.attributeTypes.length){f=p.attributeTypes;for(i in f)n=f[i],r=null,"object"===("undefined"==typeof n?"undefined":_typeof(n))&&(r=n.data,n=n.type),d=function(){switch(!1){case n!==this.inputTypes.STRING:return this.generateInput(e,p.name,i,p.counter,m[i],"text",p.attributeLabels[i]);case n!==this.inputTypes.DATE:return this.generateDateInput(e,p.name,i,p.counter,m[i],"text",p.attributeLabels[i]);case n!==this.inputTypes.TEXT:return this.generateEditor(e,p.name,i,p.counter,m[i],"text",p.attributeLabels[i]);case n!==this.inputTypes.HIDDEN:return this.generateInput(e,p.name,i,p.counter,m[i],"hidden",p.attributeLabels[i]);case n!==this.inputTypes.BOOLEAN:return this.generateInput(e,p.name,i,p.counter,m[i],"checkbox",p.attributeLabels[i]);case n!==this.inputTypes.DROPDOWN:return this.generateDropdown(e,p.name,i,p.counter,p.attributeLabels[i],r||p.dropdownValues,m[p.dropdownValueAttribute],p.filterAttribute,p.sortAttribute,p.dropdownPrefixAttribute,i);default:return document.createElement("div")}}.call(this),u.appendChild(d)}else if(p.type===this.types.STRING||p.type===this.types.DATE||p.type===this.types.TEXT_BLOCK){b=p.attributes;for(l in b)i=b[l],t.call(p.dateAttributes,i)>=0?u.appendChild(this.generateDateInput(e,p.name,i,p.counter,m[i],"text",p.attributeLabels[i])):p.type===this.types.TEXT_BLOCK?u.appendChild(this.generateEditor(e,p.name,i,p.counter,m[i],"text",p.attributeLabels[i])):u.appendChild(this.generateInput(e,p.name,i,p.counter,m[i],"text",p.attributeLabels[i]))}else p.type===this.types.DROPDOWN&&u.appendChild(this.generateDropdown(e,p.name,p.dropdownAttribute,p.counter,p.attributeLabels[p.dropdownAttribute],p.dropdownValues,m[p.dropdownValueAttribute],p.filterAttribute,p.sortAttribute,p.dropdownPrefixAttribute,p.dropdownValueAttribute));o=document.createDocumentFragment(),o.appendChild(a),o.appendChild(this.generateContainer(u)),document.getElementById("content_"+e).appendChild(o),jQuery("#"+y).collapsible({defaultOpen:y}),this.createSelect2(y),this.bindAutocomplete()}return p.existsShowen=!0}}},{key:"bindClose",value:function(e){var t=this;return jQuery("body").on("click","#exit_"+e,function(){if(confirm(t.translate("deleteConfirmation")))return jQuery("#section_"+e).next().remove(),jQuery("#section_"+e).remove()})}},{key:"addToAutocomplete",value:function(e,t,n){return this.completes.push({id:e,modelName:t,attribute:n})}},{key:"bindAutocomplete",value:function(){var e,t,n,r,i,a;for(r=this.completes,e=0,t=r.length;e<t;e++)n=r[e],i=jQuery("#"+n.id),"undefined"==typeof i&&console.error("Bad selector identifier gets for input autocomplete"),a=location.protocol+"//"+location.host+"/content/autocomplete",i.autocomplete({serviceUrl:a,noSuggestionNotice:this.translate("noResults"),deferRequestBy:200,params:{modelName:n.modelName,attributeName:n.attribute}});return this.completes=[]}},{key:"createSelect2",value:function(e){return jQuery("#"+e).next().contents().find("select").select2()}},{key:"setTranslation",value:function(e){return this.i18n=e}},{key:"translate",value:function(e){return"undefined"!=typeof this.i18n[e]?this.i18n[e]:e}}]),e}();return e.prototype.types={STRING:"string",DROPDOWN:"dropdown",DATE:"date",TEXT_BLOCK:"editor"},e.prototype.inputTypes={TEXT:"text",DATE:"date",STRING:"string",BOOLEAN:"boolean",DROPDOWN:"dropdown",SELECT2:"select2",HIDDEN:"hidden"},e.prototype.models={},e.prototype.completes=[],e.prototype.ordersListener={},e}.call(this),window.polyfield=new e}).call(void 0);