"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(function(){var e,y=[].indexOf;e=function(){var e=(_createClass(t,[{key:"push",value:function(e){return"object"!==(void 0===e?"undefined":_typeof(e))?console.log("Bad identifier for polyfield "+e):(e.counter=0,e.existsShowen=!e.exists,this.models[e.id]=e,this.appendExists(e.id),this.bindEvent(e.id))}},{key:"bindEvent",value:function(e){var t=this;return void 0===this.models[e]?console.log("Can not find object for what need to bind event"):jQuery("#button_"+e).on("click",function(){return t.hideExcess(e),t.appendTemplate(e)})}},{key:"hideExcess",value:function(e){if(jQuery("."+e).length)return jQuery("."+e).collapsible("closeAll")}},{key:"generateLabel",value:function(e,t,n){var r;return n=n||"col-xs-4 col-sm-4 col-md-3 col-lg-3",(r=document.createElement("label")).setAttribute("class",n+" control-label"),r.setAttribute("for",e),r.appendChild(document.createTextNode(t)),r}},{key:"generateInput",value:function(e,t,n,r,i,o,a,l){var u,s,d,c;return void 0!==i&&i||(i=""),void 0===o&&(o="hidden"),void 0===a&&(a=!1),void 0===l&&(l=!0),(s=document.createElement("div")).setAttribute("class","form-group"),o!==this.inputTypes.HIDDEN&&a&&s.appendChild(this.generateLabel(n+r,a)),(u=document.createElement("div")).setAttribute("class","col-xs-6 col-sm-6 col-md-7 col-lg-7"),(d=document.createElement("input")).setAttribute("type",o),d.setAttribute("name",t+"["+r+"]["+n+"]"),o!==this.inputTypes.HIDDEN&&(c=n+e+r,d.setAttribute("id",c),!0===l&&this.addToAutocomplete(c,t,n)),"checkbox"===o&&i&&d.setAttribute("checked","checked"),d.setAttribute("class","form-control"),"checkbox"!==o?d.setAttribute("value",i):d.setAttribute("value","1"),u.appendChild(d),s.appendChild(u),s}},{key:"generateEditor",value:function(e,t,n,r,i,o,a){var l,u,s,d,c;return void 0===i&&(i=""),void 0===o&&(o="hidden"),void 0===a&&(a=!1),(u=document.createElement("div")).setAttribute("class","form-group"),a&&u.appendChild(this.generateLabel(n+r,a,"col-xs-1")),(l=document.createElement("div")).setAttribute("class","col-xs-9"),(s=document.createElement("textarea")).setAttribute("name",t+"["+r+"]["+n+"]"),d=n+e+r,s.setAttribute("id",d),s.setAttribute("class","form-control"),s.appendChild(document.createTextNode(i)),l.appendChild(s),(c=document.createElement("script")).appendChild(document.createTextNode("tinymce.init({ selector: '#"+d+"', language: 'ru', relative_urls: false, remove_script_host: false, height: 300, fontsize_formats: '6pt 7pt 8pt 9pt 10pt 11pt 12pt 13pt 14pt 15pt 16pt 18pt 20pt 24pt 28pt 36pt 40pt 48pt', plugins: [ 'advlist autolink lists link image charmap print preview hr anchor pagebreak', 'searchreplace wordcount visualblocks visualchars code fullscreen', 'insertdatetime media nonbreaking save table contextmenu directionality', 'emoticons template paste textcolor quotes insertfbframe' ], toolbar: [ 'undo redo | fontsizeselect | bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | forecolor backcolor | print preview media frame' ], image_advtab: true, image_class_list: [ {title: 'Без масштабирования', value: 'no-scale-image'}, {title: 'С масштабированием', value: 'scale-image'} ], image_caption: true });")),l.appendChild(c),u.appendChild(l),u}},{key:"generateOptions",value:function(e,t,n,i,r,o,a,l){var u,s,d,c,p,m,h,b,f,v,y;if(void 0===r&&(r=""),void 0===s&&(s=!1),i=i||t,o=o||"id",a=a||[],f=document.createDocumentFragment(),e.sort)for(e=e.sort(function(e,t){var n,r;return e[i]?t[i]?(n=e[i].toUpperCase(),(r=t[i].toUpperCase())<n?1:n<r?-1:0):1:-1}),u=a.map(function(e){return e[t]}),d=0,m=(e=e.filter(function(e){return-1===u.indexOf(e[t])})).length;d<m;d++){for(c in b=l,y=e[d])v=y[c],b=b.replace("{"+c+"}",v);r.length&&(b=y[r]+" - "+b),(h=document.createElement("option")).setAttribute("value",y[o]),h.appendChild(document.createTextNode(b)),String(y[o])===String(n)&&h.setAttribute("selected",!0),f.appendChild(h)}else for(p in e)b=y=e[p],(h=document.createElement("option")).setAttribute("value",p),h.appendChild(document.createTextNode(b)),String(p)===String(n)&&h.setAttribute("selected",!0),f.appendChild(h);return f}},{key:"generateDropdown",value:function(e,t,n,r,i,o,a,l,u,s,d,c,p){var m,h,b,f,v,y,g,A,C,E,T=this;return void 0===s&&(s=""),void 0===a&&(a=!1),void 0===l&&(l=!1),A=document.createElement("div"),m=document.createDocumentFragment(),E=n+e+r,A.setAttribute("class","form-group"),A.appendChild(this.generateLabel(E,i)),(h=document.createElement("div")).setAttribute("class","col-xs-6 col-sm-6 col-md-7 col-lg-7"),(C=document.createElement("select")).setAttribute("name",t+"["+r+"]["+d+"]"),C.appendChild(this.generateOptions(o,n,a,u,s,d,c,p)),C.setAttribute("id",E),C.setAttribute("class","form-control select2"),l&&((v=document.createElement("div")).setAttribute("class","form-group"),v.appendChild(this.generateLabel("filter"+r,this.translate("filter"))),(y=document.createElement("select")).setAttribute("id","filter"+r),g=o.filter(function(e,t,n){return!e[l]}),(b=document.createElement("option")).setAttribute("value",0),b.appendChild(document.createTextNode(this.translate("noFilter"))),y.appendChild(b),y.appendChild(this.generateOptions(g,n,null,u,s,d,null,p)),y.setAttribute("class","form-control"),(f=h.cloneNode()).appendChild(y),v.appendChild(f),m.appendChild(v),jQuery(y).on("change",function(){var e,t;return g=function(t,e,n){var r,i,o,a;if(0===(t=Number(t)))return e;if((r=e.filter(function(e){return t===Number(e[n])})).length)for(o=0,a=r.length;o<a;o++)i=r[o],r=r.concat(g(i.id,e,n));return r},e=jQuery(y),jQuery(C).empty(),t=g(e.val(),o,l),C.appendChild(T.generateOptions(t,n,a,u,s,d,null,p))})),h.appendChild(C),A.appendChild(h),m.appendChild(A),m}},{key:"generateDateInput",value:function(e,t,n,r,i,o,a){var l,u,s,d,c;return void 0===i&&(i=""),void 0===o&&(o="hidden"),void 0===a&&(a=!1),(u=document.createElement("div")).setAttribute("class","form-group"),a&&u.appendChild(this.generateLabel(n+r,a)),(l=document.createElement("div")).setAttribute("class","col-lg-5 input-group date"),(s=document.createElement("input")).setAttribute("class","form-control"),s.setAttribute("type",o),s.setAttribute("name",t+"["+r+"]["+n+"]"),s.setAttribute("value",i),(d=document.createElement("span")).setAttribute("class","input-group-addon"),(c=document.createElement("span")).setAttribute("class","glyphicon glyphicon-calendar"),d.appendChild(c),l.appendChild(s),l.appendChild(d),u.appendChild(l),$(l).datetimepicker({locale:"ru",viewMode:"years",format:"YYYY-MM-DD",keepInvalid:!0}),u}},{key:"generateOrder",value:function(e,t,n){var r,i,o,a,l,u;return a=document.createElement("div"),i=document.createDocumentFragment(),r="order-"+t,a.setAttribute("class","form-group"),a.appendChild(this.generateLabel(t+e+n,this.translate("order"))),(o=document.createElement("div")).setAttribute("class","col-lg-offset-1 col-lg-3 text-center"),(l=document.createElement("select")).setAttribute("name",t+"["+n+"][order]"),l.appendChild(this.orderOptions(n)),this.updateOrder(r,n),u=t+e+n,l.setAttribute("id",u),l.setAttribute("class","form-control "+r),o.appendChild(l),a.appendChild(o),i.appendChild(a),this.bindOrderListener(r),i}},{key:"orderOptions",value:function(e){var t,n,r,i,o;for(t=document.createDocumentFragment(),n=r=1,o=e;1<=o?r<=o:o<=r;n=1<=o?++r:--r)i=document.createElement("option"),n===e&&i.setAttribute("selected","selected"),i.setAttribute("value",n),i.appendChild(document.createTextNode(n)),t.appendChild(i);return t}},{key:"updateOrder",value:function(e,l){$("."+e).each(function(){var e,t,n,r,i,o,a;if((r=(e=$(this)).children("option").length)<l){for(a=[],t=n=i=r+1,o=l;i<=o?n<=o:o<=n;t=i<=o?++n:--n)a.push(e.append("<option>"+t+"</option>"));return a}})}},{key:"bindOrderListener",value:function(i){var o=this;return void 0===this.ordersListener[i]&&($("body").on("focus click","."+i,function(e){return o.ordersListener[i]=e.target.value}),$("body").on("change","."+i,function(t){var n,r;if(r=$(t.target),(n=o.ordersListener[i])!==r.val())return $("."+i).each(function(){var e;if((e=$(this)).val()===t.target.value&&!e.is(r))return e.val(n)})})),!0}},{key:"generateCollapsible",value:function(e,t,n){var r,i,o,a;return a="section_"+(o=e+n),(i=document.createElement("div")).setAttribute("id",a),i.setAttribute("class",e),i.appendChild(document.createTextNode(n+". "+t)),i.appendChild(document.createElement("span")),(r=document.createElement("div")).appendChild(document.createTextNode("x")),r.setAttribute("id","exit_"+o),r.setAttribute("class","polyfield-exit"),r.setAttribute("title",this.translate("deleteElement")),i.appendChild(r),this.bindClose(o),i}},{key:"generateContainer",value:function(e){var t,n;return(n=document.createElement("div")).setAttribute("class","content"),n.appendChild(document.createElement("div")),n.appendChild(e),(t=document.createElement("div")).setAttribute("class",""),t.appendChild(n),t}},{key:"appendTemplate",value:function(e){var t,n,r,i,o,a,l,u,s,d,c,p;if((s=this.models[e]).counter++,p="section_"+e+s.counter,o=this.generateCollapsible(e,s.label,s.counter),a=document.createElement("p"),s.order&&a.appendChild(this.generateOrder(e,s.name,s.counter)),void 0===s.attributeTypes.length)for(r in d=s.attributeTypes)t=d[r],n=null,"object"===(void 0===t?"undefined":_typeof(t))&&(n=t.data,t=t.type),u=function(){switch(!1){case t!==this.inputTypes.STRING:return this.generateInput(e,s.name,r,s.counter,"","text",s.attributeLabels[r],s.autocomplete);case t!==this.inputTypes.DATE:return this.generateDateInput(e,s.name,r,s.counter,"","text",s.attributeLabels[r]);case t!==this.inputTypes.TEXT:return this.generateEditor(e,s.name,r,s.counter,"","text",s.attributeLabels[r]);case t!==this.inputTypes.HIDDEN:return this.generateInput(e,s.name,r,s.counter,"","hidden",s.attributeLabels[r]);case t!==this.inputTypes.BOOLEAN:return this.generateInput(e,s.name,r,s.counter,"","checkbox",s.attributeLabels[r]);case t!==this.inputTypes.DROPDOWN:return this.generateDropdown(e,s.name,r,s.counter,s.attributeLabels[r],n||s.dropdownValues,"",s.filterAttribute,s.sortAttribute,s.dropdownPrefixAttribute,r,s.dropdownUnique?s.exists:[],s.dropdownAttributeTemplate);default:return document.createElement("div")}}.call(this),a.appendChild(u);else if(s.type===this.types.STRING||s.type===this.types.DATE)for(l in c=s.attributes)r=c[l],0<=y.call(s.dateAttributes,r)?a.appendChild(this.generateDateInput(e,s.name,r,s.counter,"","text",s.attributeLabels[r])):a.appendChild(this.generateInput(e,s.name,r,s.counter,"","text",s.attributeLabels[r],s.autocomplete));else s.type===this.types.DROPDOWN&&a.appendChild(this.generateDropdown(e,s.name,s.dropdownAttribute,s.counter,s.attributeLabels[s.dropdownAttribute],s.dropdownValues,"",s.filterAttribute,s.sortAttribute,s.dropdownPrefixAttribute,s.dropdownValueAttribute,s.dropdownUnique?s.exists:[],s.dropdownAttributeTemplate));return(i=document.createDocumentFragment()).appendChild(o),i.appendChild(this.generateContainer(a)),document.getElementById("content_"+e).appendChild(i),jQuery("#"+p).collapsible({defaultOpen:p}),this.createSelect2(p),this.bindAutocomplete()}},{key:"appendExists",value:function(e){var t,n,r,i,o,a,l,u,s,d,c,p,m,h,b,f,v;if(!(p=this.models[e]).existsShowen){for(d=0,c=(h=p.exists).length;d<c;d++){if(m=h[d],p.counter++,v="section_"+e+p.counter,i=this.generateCollapsible(e,p.label,p.counter),a=document.createElement("p"),p.order&&a.appendChild(this.generateOrder(e,p.name,p.counter)),void 0===p.attributeTypes.length)for(r in b=p.attributeTypes)t=b[r],n=null,l=p.dropdownValueAttribute,"object"===(void 0===t?"undefined":_typeof(t))&&(n=t.data,l=r,t=t.type),s=function(){switch(!1){case t!==this.inputTypes.STRING:return this.generateInput(e,p.name,r,p.counter,m[r],"text",p.attributeLabels[r],p.autocomplete);case t!==this.inputTypes.DATE:return this.generateDateInput(e,p.name,r,p.counter,m[r],"text",p.attributeLabels[r]);case t!==this.inputTypes.TEXT:return this.generateEditor(e,p.name,r,p.counter,m[r],"text",p.attributeLabels[r]);case t!==this.inputTypes.HIDDEN:return this.generateInput(e,p.name,r,p.counter,m[r],"hidden",p.attributeLabels[r]);case t!==this.inputTypes.BOOLEAN:return this.generateInput(e,p.name,r,p.counter,m[r],"checkbox",p.attributeLabels[r]);case t!==this.inputTypes.DROPDOWN:return this.generateDropdown(e,p.name,r,p.counter,p.attributeLabels[r],n||p.dropdownValues,m[l],p.filterAttribute,p.sortAttribute,p.dropdownPrefixAttribute,r,[],p.dropdownAttributeTemplate);default:return document.createElement("div")}}.call(this),a.appendChild(s);else if(p.type===this.types.STRING||p.type===this.types.DATE||p.type===this.types.TEXT_BLOCK)for(u in f=p.attributes)r=f[u],0<=y.call(p.dateAttributes,r)?a.appendChild(this.generateDateInput(e,p.name,r,p.counter,m[r],"text",p.attributeLabels[r])):p.type===this.types.TEXT_BLOCK?a.appendChild(this.generateEditor(e,p.name,r,p.counter,m[r],"text",p.attributeLabels[r])):a.appendChild(this.generateInput(e,p.name,r,p.counter,m[r],"text",p.attributeLabels[r],p.autocomplete));else p.type===this.types.DROPDOWN&&a.appendChild(this.generateDropdown(e,p.name,p.dropdownAttribute,p.counter,p.attributeLabels[p.dropdownAttribute],p.dropdownValues,m[p.dropdownValueAttribute],p.filterAttribute,p.sortAttribute,p.dropdownPrefixAttribute,p.dropdownValueAttribute,[],p.dropdownAttributeTemplate));(o=document.createDocumentFragment()).appendChild(i),o.appendChild(this.generateContainer(a)),document.getElementById("content_"+e).appendChild(o),jQuery("#"+v).collapsible({defaultOpen:v}),this.createSelect2(v),this.bindAutocomplete()}return p.existsShowen=!0}}},{key:"bindClose",value:function(e){var t=this;return jQuery("body").on("click","#exit_"+e,function(){if(confirm(t.translate("deleteConfirmation")))return jQuery("#section_"+e).next().remove(),jQuery("#section_"+e).remove()})}},{key:"addToAutocomplete",value:function(e,t,n){return this.completes.push({id:e,modelName:t,attribute:n})}},{key:"bindAutocomplete",value:function(){var e,t,n,r,i,o;for(e=0,t=(r=this.completes).length;e<t;e++)n=r[e],void 0===(i=jQuery("#"+n.id))&&console.error("Bad selector identifier gets for input autocomplete"),o=location.protocol+"//"+location.host+"/content/autocomplete",i.autocomplete({serviceUrl:o,noSuggestionNotice:this.translate("noResults"),deferRequestBy:200,params:{modelName:n.modelName,attributeName:n.attribute},triggerSelectOnValidInput:!1});return this.completes=[]}},{key:"createSelect2",value:function(e){return jQuery("#"+e).next().contents().find("select.select2").select2()}},{key:"setTranslation",value:function(e){return this.i18n=e}},{key:"translate",value:function(e){return void 0!==this.i18n[e]?this.i18n[e]:e}}]),t);function t(){_classCallCheck(this,t),jQuery("body").on("blur",'input[type="text"]',function(){return jQuery(this).val(jQuery(this).val().trim())}),this.i18n={}}return e.prototype.types={STRING:"string",DROPDOWN:"dropdown",DATE:"date",TEXT_BLOCK:"editor"},e.prototype.inputTypes={TEXT:"text",DATE:"date",STRING:"string",BOOLEAN:"boolean",DROPDOWN:"dropdown",SELECT2:"select2",HIDDEN:"hidden"},e.prototype.models={},e.prototype.completes=[],e.prototype.ordersListener={},e}.call(this),window.polyfield=new e}).call(void 0);