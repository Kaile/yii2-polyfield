(function(){var e,t=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};e=function(){function e(){jQuery("body").on("blur",'input[type="text"]',function(){return jQuery(this).val(jQuery(this).val().trim())}),this.i18n={}}return e.prototype.types={STRING:"string",DROPDOWN:"dropdown",DATE:"date",TEXT_BLOCK:"editor"},e.prototype.inputTypes={TEXT:"text",DATE:"date",STRING:"string",BOOLEAN:"boolean",DROPDOWN:"dropdown"},e.prototype.models={},e.prototype.completes=[],e.prototype.ordersListener={},e.prototype.push=function(e){return"object"!=typeof e?console.log("Bad identifier for polyfield "+e):(e.counter=0,e.existsShowen=!e.exists,this.models[e.id]=e,this.appendExists(e.id),this.bindEvent(e.id))},e.prototype.bindEvent=function(e){var t;return"undefined"==typeof this.models[e]?console.log("Can not find object for what need to bind event"):(t=jQuery("#button_"+e),t.on("click",function(t){return function(){return t.hideExcess(e),t.appendTemplate(e)}}(this)))},e.prototype.hideExcess=function(e){if(jQuery("."+e).length)return jQuery("."+e).collapsible("closeAll")},e.prototype.generateLabel=function(e,t,n){var r;return n=n||"col-xs-4 col-sm-4 col-md-3 col-lg-3",r=document.createElement("label"),r.setAttribute("class",n+" control-label"),r.setAttribute("for",e),r.appendChild(document.createTextNode(t)),r},e.prototype.generateInput=function(e,t,n,r,i,o,a){var d,u,s,p;return"undefined"!=typeof i&&i||(i=""),"undefined"==typeof o&&(o="hidden"),"undefined"==typeof a&&(a=!1),u=document.createElement("div"),u.setAttribute("class","form-group"),a&&u.appendChild(this.generateLabel(n+r,a)),d=document.createElement("div"),d.setAttribute("class","col-xs-6 col-sm-6 col-md-7 col-lg-7"),s=document.createElement("input"),s.setAttribute("type",o),s.setAttribute("name",t+"["+r+"]["+n+"]"),"hidden"!==o&&(p=n+e+r,s.setAttribute("id",p),this.addToAutocomplete(p,t,n)),"checkbox"===o&&i&&s.setAttribute("checked","checked"),s.setAttribute("class","form-control"),"checkbox"!==o?s.setAttribute("value",i):s.setAttribute("value","1"),d.appendChild(s),u.appendChild(d),u},e.prototype.generateEditor=function(e,t,n,r,i,o,a){var d,u,s,p,l,c,m;return"undefined"==typeof i&&(i=""),"undefined"==typeof o&&(o="hidden"),"undefined"==typeof a&&(a=!1),u=document.createElement("div"),u.setAttribute("class","form-group"),a&&u.appendChild(this.generateLabel(n+r,a,"col-xs-1")),d=document.createElement("div"),d.setAttribute("class","col-xs-9"),s=document.createElement("textarea"),s.setAttribute("name",t+"["+r+"]["+n+"]"),p=n+e+r,s.setAttribute("id",p),s.setAttribute("class","form-control"),s.appendChild(document.createTextNode(i)),d.appendChild(s),"undefined"==typeof tinymce&&(m=document.createElement("script"),m.setAttribute("src","tinymce/timymce.min.js"),body.appendChild(m),c=document.createElement("script"),c.setAttribute("src","tinymce/langs/ru.js"),body.appendChild(c)),l=document.createElement("script"),l.appendChild(document.createTextNode("tinymce.init({ selector: '#"+p+"', language: 'ru', height: 300, fontsize_formats: '6pt 7pt 8pt 9pt 10pt 11pt 12pt 13pt 14pt 15pt 16pt 18pt 20pt 24pt 28pt 36pt 40pt 48pt', plugins: [ 'advlist autolink lists link image charmap print preview hr anchor pagebreak', 'searchreplace wordcount visualblocks visualchars code fullscreen', 'insertdatetime media nonbreaking save table contextmenu directionality', 'emoticons template paste textcolor quotes' ], toolbar: [ 'undo redo | fontsizeselect | bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | forecolor backcolor | print preview media' ], image_advtab: true, image_class_list: [ {title: 'Без масштабирования', value: 'no-scale-image'}, {title: 'С масштабированием', value: 'scale-image'} ] });")),d.appendChild(l),u.appendChild(d),u},e.prototype.generateOptions=function(e,t,n,r,i,o,a){var d,u,s,p,l,c,m,h;for("undefined"==typeof i&&(i=""),"undefined"==typeof u&&(u=!1),r=r||t,o||(o="id"),a||(a=[]),m=document.createDocumentFragment(),e=e.sort(function(e,t){var n,i;return e[r]?t[r]?(n=e[r].toUpperCase(),i=t[r].toUpperCase(),n>i?1:n<i?-1:0):1:-1}),d=a.map(function(e){return e[t]}),e=e.filter(function(e){return d.indexOf(e[t])===-1}),s=0,p=e.length;s<p;s++)h=e[s],c=h[t],i.length&&(c=h[i]+" - "+c),l=document.createElement("option"),l.setAttribute("value",h[o]),l.appendChild(document.createTextNode(c)),h[o]===n&&l.setAttribute("selected",!0),m.appendChild(l);return m},e.prototype.generateDropdown=function(e,t,n,r,i,o,a,d,u,s,p,l){var c,m,h,b,f,y,g,A,C,v;return"undefined"==typeof s&&(s=""),"undefined"==typeof a&&(a=!1),"undefined"==typeof d&&(d=!1),A=document.createElement("div"),c=document.createDocumentFragment(),A.setAttribute("class","form-group"),A.appendChild(this.generateLabel(n+r,i)),m=document.createElement("div"),m.setAttribute("class","col-xs-6 col-sm-6 col-md-7 col-lg-7"),C=document.createElement("select"),C.setAttribute("name",t+"["+r+"]["+n+"]"),C.appendChild(this.generateOptions(o,n,a,u,s,p,l)),v=n+e+r,C.setAttribute("id",v),C.setAttribute("class","form-control"),d&&(f=document.createElement("div"),f.setAttribute("class","form-group"),f.appendChild(this.generateLabel("filter"+r,this.translate("filter"))),y=document.createElement("select"),y.setAttribute("id","filter"+r),g=o.filter(function(e,t,n){return!e[d]}),h=document.createElement("option"),h.setAttribute("value",0),h.appendChild(document.createTextNode(this.translate("noFilter"))),y.appendChild(h),y.appendChild(this.generateOptions(g,n,null,u,s,p)),y.setAttribute("class","form-control"),b=m.cloneNode(),b.appendChild(y),f.appendChild(b),c.appendChild(f),jQuery(y).on("change",function(e){return function(){var t,r,i;return g=function(e,t,n){var r,i,o,a;if(e=Number(e),0===e)return t;if(r=t.filter(function(t){return e===Number(t[n])}),r.length)for(o=0,a=r.length;o<a;o++)i=r[o],r=r.concat(g(i.id,t,n));return r},t=jQuery(y),r=jQuery(C),r.empty(),i=g(t.val(),o,d),C.appendChild(e.generateOptions(i,n,a,u,s,p))}}(this))),m.appendChild(C),A.appendChild(m),c.appendChild(A),c},e.prototype.generateDateInput=function(e,t,n,r,i,o,a){var d,u,s,p,l;return"undefined"==typeof i&&(i=""),"undefined"==typeof o&&(o="hidden"),"undefined"==typeof a&&(a=!1),u=document.createElement("div"),u.setAttribute("class","form-group"),a&&u.appendChild(this.generateLabel(n+r,a)),d=document.createElement("div"),d.setAttribute("class","col-lg-5 input-group date"),s=document.createElement("input"),s.setAttribute("class","form-control"),s.setAttribute("type",o),s.setAttribute("name",t+"["+r+"]["+n+"]"),s.setAttribute("value",i),p=document.createElement("span"),p.setAttribute("class","input-group-addon"),l=document.createElement("span"),l.setAttribute("class","glyphicon glyphicon-calendar"),p.appendChild(l),d.appendChild(s),d.appendChild(p),u.appendChild(d),$(d).datetimepicker({locale:"ru",viewMode:"years",format:"YYYY-MM-DD"}),u},e.prototype.generateOrder=function(e,t,n){var r,i,o,a,d,u;return a=document.createElement("div"),i=document.createDocumentFragment(),r="order-"+t,a.setAttribute("class","form-group"),a.appendChild(this.generateLabel(t+e+n,this.translate("order"))),o=document.createElement("div"),o.setAttribute("class","col-lg-offset-1 col-lg-3 text-center"),d=document.createElement("select"),d.setAttribute("name",t+"["+n+"][order]"),d.appendChild(this.orderOptions(n)),this.updateOrder(r,n),u=t+e+n,d.setAttribute("id",u),d.setAttribute("class","form-control "+r),o.appendChild(d),a.appendChild(o),i.appendChild(a),this.bindOrderListener(r),i},e.prototype.orderOptions=function(e){var t,n,r,i,o;for(t=document.createDocumentFragment(),n=r=1,o=e;1<=o?r<=o:r>=o;n=1<=o?++r:--r)i=document.createElement("option"),n===e&&i.setAttribute("selected","selected"),i.setAttribute("value",n),i.appendChild(document.createTextNode(n)),t.appendChild(i);return t},e.prototype.updateOrder=function(e,t){var n;n=$("."+e),n.each(function(){var e,n,r,i,o,a,d;if(e=$(this),i=e.children("option").length,i<t){for(d=[],n=r=o=i+1,a=t;o<=a?r<=a:r>=a;n=o<=a?++r:--r)d.push(e.append("<option>"+n+"</option>"));return d}})},e.prototype.bindOrderListener=function(e){return"undefined"==typeof this.ordersListener[e]&&($("body").on("focus click","."+e,function(t){return function(n){return t.ordersListener[e]=n.target.value}}(this)),$("body").on("change","."+e,function(t){return function(n){var r,i;if(i=$(n.target),r=t.ordersListener[e],r!==i.val())return $("."+e).each(function(){var e;if(e=$(this),e.val()===n.target.value&&!e.is(i))return e.val(r)})}}(this))),!0},e.prototype.generateCollapsible=function(e,t,n){var r,i,o,a;return o=e+n,a="section_"+o,i=document.createElement("div"),i.setAttribute("id",a),i.setAttribute("class",e),i.appendChild(document.createTextNode(n+". "+t)),i.appendChild(document.createElement("span")),r=document.createElement("div"),r.appendChild(document.createTextNode("x")),r.setAttribute("id","exit_"+o),r.setAttribute("class","polyfield-exit"),r.setAttribute("title",this.translate("deleteElement")),i.appendChild(r),this.bindClose(o),i},e.prototype.generateContainer=function(e){var t,n;return n=document.createElement("div"),n.setAttribute("class","content"),n.appendChild(document.createElement("div")),n.appendChild(e),t=document.createElement("div"),t.setAttribute("class",""),t.appendChild(n),t},e.prototype.appendTemplate=function(e){var n,r,i,o,a,d,u,s,p,l,c;if(s=this.models[e],s.counter++,c="section_"+e+s.counter,o=this.generateCollapsible(e,s.label,s.counter),a=document.createElement("p"),s.order&&a.appendChild(this.generateOrder(e,s.name,s.counter)),s.attributeTypes){p=s.attributeTypes;for(r in p)n=p[r],u=function(){switch(!1){case n!==this.inputTypes.STRING:return this.generateInput(e,s.name,r,s.counter,"","text",s.attributeLabels[r]);case n!==this.inputTypes.DATE:return this.generateDateInput(e,s.name,r,s.counter,"","text",s.attributeLabels[r]);case n!==this.inputTypes.TEXT:return this.generateEditor(e,s.name,r,s.counter,"","text",s.attributeLabels[r]);case n!==this.inputTypes.BOOLEAN:return this.generateInput(e,s.name,r,s.counter,"","checkbox",s.attributeLabels[r]);case n!==this.inputTypes.DROPDOWN:return this.generateDropdown(e,s.name,s.dropdownAttribute,s.counter,s.attributeLabels[s.dropdownAttribute],s.dropdownValues,"",s.filterAttribute,s.sortAttribute,s.dropdownPrefixAttribute,s.dropdownValueAttribute,s.dropdownUnique?s.exists:[]);default:return document.createElement("div")}}.call(this),a.appendChild(u)}else if(s.type===this.types.STRING||s.type===this.types.DATE){l=s.attributes;for(d in l)r=l[d],t.call(s.dateAttributes,r)>=0?a.appendChild(this.generateDateInput(e,s.name,r,s.counter,"","text",s.attributeLabels[r])):a.appendChild(this.generateInput(e,s.name,r,s.counter,"","text",s.attributeLabels[r]))}else s.type===this.types.DROPDOWN&&a.appendChild(this.generateDropdown(e,s.name,s.dropdownAttribute,s.counter,s.attributeLabels[s.dropdownAttribute],s.dropdownValues,"",s.filterAttribute,s.sortAttribute,s.dropdownPrefixAttribute,s.dropdownValueAttribute,s.dropdownUnique?s.exists:[]));return i=document.createDocumentFragment(),i.appendChild(o),i.appendChild(this.generateContainer(a)),document.getElementById("content_"+e).appendChild(i),jQuery("#"+c).collapsible({defaultOpen:""+c}),this.bindAutocomplete()},e.prototype.appendExists=function(e){var n,r,i,o,a,d,u,s,p,l,c,m,h,b,f;if(l=this.models[e],!l.existsShowen){for(m=l.exists,s=0,p=m.length;s<p;s++){if(c=m[s],l.counter++,f="section_"+e+l.counter,i=this.generateCollapsible(e,l.label,l.counter),a=document.createElement("p"),l.order&&a.appendChild(this.generateOrder(e,l.name,l.counter)),l.attributeTypes){h=l.attributeTypes;for(r in h)n=h[r],u=function(){switch(!1){case n!==this.inputTypes.STRING:return this.generateInput(e,l.name,r,l.counter,c[r],"text",l.attributeLabels[r]);case n!==this.inputTypes.DATE:return this.generateDateInput(e,l.name,r,l.counter,c[r],"text",l.attributeLabels[r]);case n!==this.inputTypes.TEXT:return this.generateEditor(e,l.name,r,l.counter,c[r],"text",l.attributeLabels[r]);case n!==this.inputTypes.BOOLEAN:return this.generateInput(e,l.name,r,l.counter,c[r],"checkbox",l.attributeLabels[r]);case n!==this.inputTypes.DROPDOWN:return this.generateDropdown(e,l.name,l.dropdownAttribute,l.counter,l.attributeLabels[l.dropdownAttribute],l.dropdownValues,c[l.dropdownValueAttribute],l.filterAttribute,l.sortAttribute,l.dropdownPrefixAttribute,l.dropdownValueAttribute);default:return document.createElement("div")}}.call(this),a.appendChild(u)}else if(l.type===this.types.STRING||l.type===this.types.DATE||l.type===this.types.TEXT_BLOCK){b=l.attributes;for(d in b)r=b[d],t.call(l.dateAttributes,r)>=0?a.appendChild(this.generateDateInput(e,l.name,r,l.counter,c[r],"text",l.attributeLabels[r])):l.type===this.types.TEXT_BLOCK?a.appendChild(this.generateEditor(e,l.name,r,l.counter,c[r],"text",l.attributeLabels[r])):a.appendChild(this.generateInput(e,l.name,r,l.counter,c[r],"text",l.attributeLabels[r]))}else l.type===this.types.DROPDOWN&&a.appendChild(this.generateDropdown(e,l.name,l.dropdownAttribute,l.counter,l.attributeLabels[l.dropdownAttribute],l.dropdownValues,c[l.dropdownValueAttribute],l.filterAttribute,l.sortAttribute,l.dropdownPrefixAttribute,l.dropdownValueAttribute));o=document.createDocumentFragment(),o.appendChild(i),o.appendChild(this.generateContainer(a)),document.getElementById("content_"+e).appendChild(o),jQuery("#"+f).collapsible({defaultOpen:f}),this.bindAutocomplete()}return l.existsShowen=!0}},e.prototype.bindClose=function(e){return jQuery("body").on("click","#exit_"+e,function(t){return function(){if(confirm(t.translate("deleteConfirmation")))return jQuery("#section_"+e).next().remove(),jQuery("#section_"+e).remove()}}(this))},e.prototype.addToAutocomplete=function(e,t,n){return this.completes.push({id:e,modelName:t,attribute:n})},e.prototype.bindAutocomplete=function(){var e,t,n,r,i,o;for(r=this.completes,e=0,t=r.length;e<t;e++)n=r[e],i=jQuery("#"+n.id),"undefined"==typeof i&&console.error("Bad selector identifier gets for input autocomplete"),o=location.protocol+"//"+location.host+"/content/autocomplete",i.autocomplete({serviceUrl:o,noSuggestionNotice:this.translate("noResults"),deferRequestBy:200,params:{modelName:n.modelName,attributeName:n.attribute}});return this.completes=[]},e.prototype.setTranslation=function(e){return this.i18n=e},e.prototype.translate=function(e){return"undefined"!=typeof this.i18n[e]?this.i18n[e]:e},e}(),window.polyfield=new e}).call(this);